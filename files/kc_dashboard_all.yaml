max_columns: 4
title: Kidname Chores
path: Kidname
sections:
  - type: grid
    cards:
      - square: false
        type: grid
        columns: 1
        cards:
          - type: custom:auto-entities
            card:
              square: false
              type: grid
              columns: 1
            card_param: cards
            filter:
              template: >-
                {#-- ============================================= --#}
                {#-- ========== Version KCD_0.4.0beta2 =========== --#}
                {#-- ============================================= --#}

                {#-- ===== WELCOME CARD ===== --#}

                {#-- 1. User Configuration --#}
                {%- set Kid_name = 'Kidname' -%}

                {#-- 2. Initialize Variables --#}
                {%- set Kid_name_normalize = Kid_name | slugify() -%}
                {%- set dashboard_helper = 'sensor.kc_' ~ Kid_name_normalize ~ '_ui_dashboard_helper' -%}
                {%- set points_sensor = 'sensor.kc_' ~ Kid_name_normalize ~ '_points' -%}
                {%- set total_sensor = 'sensor.kc_' ~ Kid_name_normalize ~ '_chores_completed_total' -%}
                {%- set highest_badge_entity = 'sensor.kc_' ~ Kid_name_normalize ~ '_highest_badge' -%}

                {#-- 3. Collect Data --#}
                {%- set ui = (state_attr(dashboard_helper, 'ui_translations') or {}) -%}
                {%- set points = states(points_sensor) | int(default=0) -%}
                {%- set points_label = state_attr(points_sensor, 'unit_of_measurement') -%}
                {%- set points_icon = state_attr(points_sensor, 'icon') -%}
                {%- set weekly_completed = state_attr(total_sensor, 'chore_stat_approved_week') | int(default=0) -%}
                {%- set todays_completed = state_attr(total_sensor, 'chore_stat_approved_today') | int(default=0) -%}
                {%- set highest_badge = states(highest_badge_entity) or 'None' -%}
                {%- set highest_badge_icon = state_attr(highest_badge_entity, 'icon') or 'mdi:medal-outline' -%}
                {%- set highest_badge_multiplier = (state_attr(highest_badge_entity, 'awards') or {}).get('points_multiplier') | float(default=1) -%}

                {#-- 4. Build Display --#}
                {%- if highest_badge not in ['None', 'unknown', 'Unknown', 'unavailable'] -%}
                  {%- if highest_badge_multiplier > 1 -%}
                    {%- set badge_display = "<ha-icon icon='" ~ highest_badge_icon ~ "'></ha-icon> " ~ highest_badge ~ " (x" ~ highest_badge_multiplier|string ~ ")  \n" -%}
                  {%- else -%}
                    {%- set badge_display = "<ha-icon icon='" ~ highest_badge_icon ~ "'></ha-icon> " ~ highest_badge ~ "  \n" -%}
                  {%- endif -%}
                {%- else -%}
                  {%- set badge_display = "" -%}
                {%- endif -%}

                {%- set content =
                  "## üëã " ~ ui.get('welcome', 'err-welcome') ~ ", " ~ Kid_name ~ "! \n"
                  "#### <ha-icon icon=" ~ points_icon ~ "></ha-icon>&nbsp;&nbsp;" ~ points_label ~ ": &nbsp;&nbsp;" ~ points ~ "&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;" ~ badge_display ~ " \n"
                  "**üìÖ " ~ ui.get('weekly_completed', 'err-weekly_completed') ~ ":** &nbsp;&nbsp;" ~ weekly_completed ~ "  \n"
                  "**‚òÄÔ∏è " ~ ui.get('todays_completed', 'err-todays_completed') ~ ":** &nbsp;&nbsp;" ~ todays_completed ~ "  \n\n"
                -%}

                {#-- 5. Render --#}
                {{
                  {
                    'type': 'markdown',
                    'content': content
                  }
                }},
      - type: grid
        square: false
        columns: 1
        cards:
          - type: custom:auto-entities
            card:
              square: false
              type: grid
              columns: 1
            card_param: cards
            filter:
              template: >-
                {#-- ===== CHORES CARD ===== --#}

                {#-- 1. User Configuration --#}
                {%- set Kid_name = 'Kidname' -%}
                {%- set pref_column_count = 2 -%}
                {%- set pref_use_overdue_grouping = true -%}
                {%- set pref_use_today_grouping = true -%}
                {%- set pref_include_daily_recurring_in_today = true -%}
                {%- set pref_use_this_week_grouping = true -%}
                {%- set pref_include_weekly_recurring_in_this_week = true -%}
                {%- set pref_exclude_approved = false -%}
                {%- set pref_use_label_grouping = true -%}
                {%- set pref_exclude_label_list = ["Example_label_1", "Example_label_2"] -%}
                {%- set pref_label_display_order = ["Kitchen", "Bedroom", "Outdoor"] -%}
                {%- set pref_sort_within_groups = 'default' -%}  {#-- Options: 'default', 'name_asc', 'name_desc', 'date_asc', 'date_desc' --#}

                {#-- 2. Initialize Variables --#}
                {%- set Kid_name_normalize = Kid_name | slugify() -%}
                {%- set dashboard_helper = 'sensor.kc_' ~ Kid_name_normalize ~ '_ui_dashboard_helper' -%}
                {%- set points_sensor = 'sensor.kc_' ~ Kid_name_normalize ~ '_points' -%}
                {%- set points_label = state_attr(points_sensor, 'unit_of_measurement') -%}
                {%- set points_icon = state_attr(points_sensor, 'icon') -%}

                {%- set ns = namespace(
                  overdue_buttons=[],
                  am_buttons=[],
                  today_buttons=[],
                  this_week_buttons=[],
                  other_buttons=[],
                  label_button_groups=[],
                  label_order=[],
                  group_cards=[]
                ) -%}

                {#-- 3. Collect Data --#}
                {%- set ui = state_attr(dashboard_helper, 'ui_translations') or {} -%}
                {%- set chore_list = state_attr(dashboard_helper, 'chores') | default([], true) -%}
                {%- set chores_by_label_raw = state_attr(dashboard_helper, 'chores_by_label') | default({}, true) -%}

                {#-- 4. Build Display --#}
                {%- for chore in chore_list -%}
                  {%- set chore_sensor_id = chore.eid if chore is mapping else chore -%}
                  {%- set chore_status = chore.status if chore is mapping else states(chore_sensor_id) -%}
                  {%- set chore_labels = chore.labels if chore is mapping else state_attr(chore_sensor_id, 'labels') | default([], true) -%}
                  {%- set chore_primary_group = chore.primary_group if chore is mapping else state_attr(chore_sensor_id, 'primary_group') | default('other') -%}
                  {%- set chore_is_today_am = chore.is_today_am if chore is mapping else state_attr(chore_sensor_id, 'is_today_am') -%}

                  {#-- Step 1: Skip if chore labels match exclude list --#}
                  {%- if not (chore_labels | select('in', pref_exclude_label_list) | list | count > 0) -%}

                    {#-- Step 2: Skip approved chores if preference set --#}
                    {%- if chore_status == 'approved' and pref_exclude_approved -%}
                      {#-- Skip this chore --#}

                    {#-- Step 3: Handle overdue chores (highest priority) --#}
                    {%- elif chore_status == 'overdue' and pref_use_overdue_grouping -%}
                      {%- set ns.overdue_buttons = ns.overdue_buttons + [chore_sensor_id] -%}

                    {#-- Step 4: Skip chores with labels when label grouping is enabled (they're processed separately) --#}
                    {%- elif pref_use_label_grouping and (chore_labels | default([], true) | list | length > 0) -%}
                      {#-- Labels take priority; processed in label grouping section below --#}

                    {#-- Step 5: Handle recurring filters BEFORE primary_group logic (override primary_group assignment) --#}
                    {#-- If a chore is in 'today' group without specific date, it's daily recurring --#}
                    {%- elif chore_primary_group == 'today' and not pref_include_daily_recurring_in_today -%}
                      {%- set ns.other_buttons = ns.other_buttons + [chore_sensor_id] -%}

                    {#-- If a chore is in 'this_week' group without specific date, it's weekly recurring --#}
                    {%- elif chore_primary_group == 'this_week' and not pref_include_weekly_recurring_in_this_week -%}
                      {%- set ns.other_buttons = ns.other_buttons + [chore_sensor_id] -%}

                    {#-- Step 6: Categorize by primary_group (time-based) --#}
                    {%- elif chore_primary_group == 'today' and pref_use_today_grouping and chore_is_today_am == true -%}
                      {%- set ns.am_buttons = ns.am_buttons + [chore_sensor_id] -%}

                    {%- elif chore_primary_group == 'today' and pref_use_today_grouping and chore_is_today_am != true -%}
                      {%- set ns.today_buttons = ns.today_buttons + [chore_sensor_id] -%}

                    {%- elif chore_primary_group == 'today' and not pref_use_today_grouping -%}
                      {%- set ns.other_buttons = ns.other_buttons + [chore_sensor_id] -%}

                    {%- elif chore_primary_group == 'this_week' and pref_use_this_week_grouping -%}
                      {%- set ns.this_week_buttons = ns.this_week_buttons + [chore_sensor_id] -%}

                    {%- elif chore_primary_group == 'this_week' and not pref_use_this_week_grouping -%}
                      {%- set ns.other_buttons = ns.other_buttons + [chore_sensor_id] -%}

                    {#-- Step 7: Default fallback --#}
                    {%- else -%}
                      {%- set ns.other_buttons = ns.other_buttons + [chore_sensor_id] -%}
                    {%- endif -%}

                  {%- endif -%}
                {%- endfor -%}

                {#-- Build Label Groups from chores_by_label --#}
                {%- if pref_use_label_grouping -%}
                  {#-- Determine label order: use pref_label_display_order if provided, else all labels alphabetically --#}
                  {%- if pref_label_display_order | length > 0 -%}
                    {%- set ns.label_order = pref_label_display_order -%}
                  {%- else -%}
                    {%- set ns.label_order = chores_by_label_raw.keys() | list | sort -%}
                  {%- endif -%}

                  {#-- Build label button groups in order --#}
                  {%- for label in ns.label_order -%}
                    {%- if label not in pref_exclude_label_list and label in chores_by_label_raw -%}
                      {%- set label_eids = chores_by_label_raw[label] | default([], true) -%}
                      {%- set ns.temp_label_buttons = [] -%}
                      {%- for eid in label_eids -%}
                        {%- if eid not in (ns.overdue_buttons | list) -%}
                          {%- set ns.temp_label_buttons = ns.temp_label_buttons + [eid] -%}
                        {%- endif -%}
                      {%- endfor -%}
                      {%- if ns.temp_label_buttons | length > 0 -%}
                        {%- set ns.label_button_groups = ns.label_button_groups + [{'name': label, 'buttons': ns.temp_label_buttons, 'icon': 'mdi:label'}] -%}
                      {%- endif -%}
                    {%- endif -%}
                  {%- endfor -%}

                  {#-- Add any remaining labels not in pref_label_display_order (alphabetically sorted) --#}
                  {%- if pref_label_display_order | length > 0 -%}
                    {%- set remaining_labels = chores_by_label_raw.keys() | list | sort | reject('in', pref_label_display_order) | list -%}
                    {%- for label in remaining_labels -%}
                      {%- if label not in pref_exclude_label_list -%}
                        {%- set label_eids = chores_by_label_raw[label] | default([], true) -%}
                        {%- set ns.temp_label_buttons = [] -%}
                        {%- for eid in label_eids -%}
                          {%- if eid not in (ns.overdue_buttons | list) -%}
                            {%- set ns.temp_label_buttons = ns.temp_label_buttons + [eid] -%}
                          {%- endif -%}
                        {%- endfor -%}
                        {%- if ns.temp_label_buttons | length > 0 -%}
                          {%- set ns.label_button_groups = ns.label_button_groups + [{'name': label, 'buttons': ns.temp_label_buttons, 'icon': 'mdi:label'}] -%}
                        {%- endif -%}
                      {%- endif -%}
                    {%- endfor -%}
                  {%- endif -%}
                {%- endif -%}

                {#-- Build the button groups --#}
                {%- set button_groups = [
                    {'name': "!!!!!!!!!!! " ~ ui.get('overdue', 'err-overdue') ~ " !!!!!!!!!!!", 'buttons': ns.overdue_buttons, 'icon': 'mdi:alert-octagon'},
                    {'name': ui.get('due_this_morning', 'err-due_this_morning'), 'buttons': ns.am_buttons, 'icon': 'mdi:alarm'},
                    {'name': ui.get('due_today', 'err-due_today'), 'buttons': ns.today_buttons, 'icon': 'mdi:calendar-today'},
                    {'name': ui.get('due_this_week', 'err-due_this_week'), 'buttons': ns.this_week_buttons, 'icon': 'mdi:calendar-week'}
                ] -%}

                {#-- Insert label-based groups --#}
                {%- set button_groups = button_groups + ns.label_button_groups -%}

                {#-- Continue with bonus group --#}
                {%- set button_groups = button_groups + [
                    {'name': ui.get('upcoming_bonus', 'err-upcoming_bonus'), 'buttons': ns.other_buttons, 'icon': 'mdi:calendar-clock'}
                ] -%}

                {#-- Sort chores within each group based on preference --#}
                {%- if pref_sort_within_groups != 'default' -%}
                  {%- set ns.sorted_groups = [] -%}
                  {%- for group in button_groups -%}
                    {%- if group.buttons | length > 0 -%}
                      {%- if pref_sort_within_groups in ['name_asc', 'name_desc'] -%}
                        {#-- Build list of (name, eid) tuples for sorting --#}
                        {%- set ns.temp_list = [] -%}
                        {%- for eid in group.buttons -%}
                          {%- set chore_name = state_attr(eid, 'chore_name') | default('zzz', true) | lower -%}
                          {%- set ns.temp_list = ns.temp_list + [[chore_name, eid]] -%}
                        {%- endfor -%}
                        {#-- Sort the list --#}
                        {%- set sorted_list = ns.temp_list | sort -%}
                        {%- if pref_sort_within_groups == 'name_desc' -%}
                          {%- set sorted_list = sorted_list | reverse | list -%}
                        {%- endif -%}
                        {#-- Extract just the entity IDs --#}
                        {%- set sorted_buttons = sorted_list | map('last') | list -%}
                        {%- set ns.sorted_groups = ns.sorted_groups + [{'name': group.name, 'buttons': sorted_buttons, 'icon': group.icon}] -%}
                      {%- elif pref_sort_within_groups in ['date_asc', 'date_desc'] -%}
                        {#-- Build list of (due_date_timestamp, eid) tuples for sorting --#}
                        {%- set ns.temp_list = [] -%}
                        {%- for eid in group.buttons -%}
                          {%- set due_date_str = state_attr(eid, 'due_date') | string -%}
                          {%- if due_date_str not in ['None', 'unknown', 'unavailable'] -%}
                            {%- set due_timestamp = as_timestamp(due_date_str) | default(9999999999, true) -%}
                          {%- else -%}
                            {%- set due_timestamp = 9999999999 -%}
                          {%- endif -%}
                          {%- set ns.temp_list = ns.temp_list + [[due_timestamp, eid]] -%}
                        {%- endfor -%}
                        {#-- Sort the list --#}
                        {%- set sorted_list = ns.temp_list | sort -%}
                        {%- if pref_sort_within_groups == 'date_desc' -%}
                          {%- set sorted_list = sorted_list | reverse | list -%}
                        {%- endif -%}
                        {#-- Extract just the entity IDs --#}
                        {%- set sorted_buttons = sorted_list | map('last') | list -%}
                        {%- set ns.sorted_groups = ns.sorted_groups + [{'name': group.name, 'buttons': sorted_buttons, 'icon': group.icon}] -%}
                      {%- else -%}
                        {%- set ns.sorted_groups = ns.sorted_groups + [group] -%}
                      {%- endif -%}
                    {%- else -%}
                      {%- set ns.sorted_groups = ns.sorted_groups + [group] -%}
                    {%- endif -%}
                  {%- endfor -%}
                  {%- set button_groups = ns.sorted_groups -%}
                {%- endif -%}

                {#-- 5. Render --#}
                {{
                  {
                    'type': 'heading',
                    'icon': 'mdi:broom',
                    'heading': ui.get('chores', 'err-chores'),
                    'heading_style': 'title',
                  }
                }},

                {#-- Loop through the button groups and create all claim buttons --#}
                {%- for group in button_groups -%}
                  {%- set ns.group_cards = [] -%}
                  {%- if group.buttons | length > 0 -%}
                    {%- set heading_card =
                      {
                        'type': 'heading',
                        'icon': group.icon,
                        'heading': group.name,
                        'heading_style': 'title',
                      }
                    -%}
                    {{- heading_card -}},

                    {%- for chore_sensor_id in group.buttons -%}
                      {%- set claim_button_eid = state_attr(chore_sensor_id, 'claim_button_eid') | default('', true) -%}
                      {%- set chore_name = state_attr(chore_sensor_id, 'chore_name') | default('Unknown') -%}
                      {%- set shared_chore = state_attr(chore_sensor_id, 'shared_chore') -%}
                      {%- set primary = chore_name ~ (' (S)' if shared_chore else '') -%}
                      {%- set button_state = states(claim_button_eid) if claim_button_eid else 'unknown' -%}
                      {%- set due_date_str = state_attr(chore_sensor_id, 'due_date') | string -%}
                      {%- set due_date = as_datetime(due_date_str).astimezone(now().tzinfo) if due_date_str not in ['None', 'unknown', 'unavailable'] else None -%}
                      {%- set recurring = state_attr(chore_sensor_id, 'recurring_frequency') -%}
                      {%- set today = now().astimezone(now().tzinfo).date() -%}
                      {%- set due_date_short =
                          ui.get('daily', 'err-daily') if recurring == 'daily' and not due_date else
                          ui.get('weekly', 'err-weekly') if recurring == 'weekly' and not due_date else
                          ui.get('no_due_date', 'err-no_due_date') if not due_date else
                          (due_date.strftime('%-I:%M %p') if due_date.date() == today else as_timestamp(due_date) | timestamp_custom('%a %b %-d', true))
                      -%}

                      {%- set multi_approve = state_attr(chore_sensor_id, 'allow_multiple_claims_per_day') -%}
                      {%- set chore_state = states(chore_sensor_id) -%}
                      {%- set state_map = {
                          'pending': ui.get('pending', 'err-pending'),
                          'claimed': ui.get('claimed', 'err-claimed'),
                          'approved': ui.get('approved', 'err-approved'),
                          'overdue': ui.get('overdue', 'err-overdue')
                      } -%}
                      {%- set chore_state_display = (state_map[chore_state] if chore_state in state_map else chore_state) ~ ' (M)' if multi_approve == true else (state_map[chore_state] if chore_state in state_map else chore_state) -%}
                      {%- set points = state_attr(chore_sensor_id, 'default_points') | string -%}
                      {%- set global_chore_state = state_attr(chore_sensor_id, 'global_state') -%}
                      {%- set streak = state_attr(chore_sensor_id, 'chore_current_streak') | string -%}
                      {%- set secondary = points_label ~ ': ' + points + '\n' + ui.get('streak', 'err-streak') + ': ' + streak + '\n \n' + ui.get('status', 'err-status') + ': ' + chore_state_display + '\n' + ui.get('due', 'err-due') + ': ' + due_date_short -%}
                      {%- set icon_color = (
                            'blue' if chore_state == 'approved' and multi_approve == true else
                            'green' if chore_state == 'approved' else
                            'yellow' if chore_state == 'partial' else
                            'orange' if chore_state == 'claimed' else
                            'red' if chore_state == 'overdue' else
                            'purple' if '_in_part' in global_chore_state else
                            'grey'
                          ) -%}
                      {%- set badge_color = (
                            'blue' if chore_state == 'approved' and multi_approve == true else
                            'green' if chore_state == 'approved' else
                            'green' if chore_state == 'partial' else
                            'green' if chore_state == 'claimed' else
                            'red' if chore_state == 'overdue' else
                            'purple' if '_in_part' in global_chore_state else
                            'grey'
                          ) -%}
                      {%- set badge_icon = (
                            'mdi:check-bold' if chore_state == 'approved' else
                            'mdi:check-bold' if chore_state == 'partial' else
                            'mdi:check-bold' if chore_state == 'claimed' else
                            'mdi:exclamation-thick' if chore_state == 'overdue' else
                            'mdi:account-group' if '_in_part' in global_chore_state else
                            ''
                          ) -%}
                      {#-- Add chore card to the group_cards list --#}
                      {%- set chore_icon = state_attr(chore_sensor_id, 'icon') | default('mdi:broom') -%}
                      {%- set ns.group_cards = ns.group_cards + [{
                          'type': 'custom:mushroom-template-card',
                          'entity': chore_sensor_id,
                          'primary': primary,
                          'multiline_secondary': 'false',
                          'secondary': secondary,
                          'layout': 'horizontal',
                          'icon': chore_icon,
                          'icon_color': icon_color,
                          'badge_color': badge_color,
                          'badge_icon': badge_icon,
                          'tap_action': {
                            'action': 'call-service',
                            'service': 'button.press',
                            'target': {
                              'entity_id': claim_button_eid
                            }
                          },
                          'hold_action': {
                            'action': 'more-info'
                          }
                      }] -%}
                    {%- endfor -%}
                    {#-- Display the grid card for this group --#}
                      {{
                        {
                          'type': 'grid',
                          'columns': pref_column_count,
                          'square': false,
                          'cards': ns.group_cards
                        }
                      }},
                  {%- endif -%}
                {%- endfor -%}
      - square: false
        type: grid
        columns: 1
        cards:
          - type: custom:auto-entities
            card:
              square: false
              type: grid
              columns: 1
            card_param: cards
            filter:
              template: >-
                {#-- ===== REWARDS CARD ===== --#}

                {#-- 1. User Configuration --#}
                {%- set Kid_name = 'Kidname' -%}
                {%- set pref_column_count = 1 -%}
                {%- set pref_use_label_grouping = false -%}
                {%- set pref_exclude_label_list = [] -%}  {#-- Example: ['junk_label', 'skip_this'] - Works with or without label grouping enabled --#}
                {%- set pref_label_display_order = [] -%}  {#-- Example: ['Toys', 'Snacks', 'Activities'] - Only applies when label grouping is enabled --#}
                {%- set pref_sort_rewards = 'default' -%}  {#-- Options: 'default', 'name_asc', 'name_desc', 'cost_asc', 'cost_desc' --#}

                {#-- 2. Initialize Variables --#}
                {%- set Kid_name_normalize = Kid_name | slugify() -%}
                {%- set dashboard_helper = 'sensor.kc_' ~ Kid_name_normalize ~ '_ui_dashboard_helper' -%}
                {%- set points_sensor = 'sensor.kc_' ~ Kid_name_normalize ~ '_points' -%}
                {%- set points_label = state_attr(points_sensor, 'unit_of_measurement') -%}
                {%- set points_icon = state_attr(points_sensor, 'icon') -%}

                {%- set ns = namespace(
                  all_labels=[],
                  label_order=[],
                  label_groups=[],
                  temp_label_rewards=[],
                  sorted_groups=[],
                  temp_list=[],
                  filtered_rewards=[],
                  group_cards=[]
                ) -%}

                {#-- 3. Collect Data --#}
                {%- set ui = state_attr(dashboard_helper, 'ui_translations') or {} -%}
                {%- set reward_list = state_attr(dashboard_helper, 'rewards') | default([], true) -%}
                {%- set current_points = states(points_sensor) | int(default=0) -%}

                {#-- Apply label exclusion filter (works regardless of grouping setting) --#}
                {%- if pref_exclude_label_list | length > 0 -%}
                  {%- for reward in reward_list -%}
                    {%- set reward_labels = reward.labels | default([], true) if reward is mapping else [] -%}
                    {%- set has_excluded = reward_labels | select('in', pref_exclude_label_list) | list | length > 0 -%}
                    {%- if not has_excluded -%}
                      {%- set ns.filtered_rewards = ns.filtered_rewards + [reward] -%}
                    {%- endif -%}
                  {%- endfor -%}
                  {%- set reward_list = ns.filtered_rewards -%}
                {%- endif -%}

                {#-- 4. Build Display Groups --#}
                {%- if pref_use_label_grouping and reward_list | length > 0 -%}
                  {#-- Determine all unique labels from rewards (only when grouping enabled) --#}
                  {%- for reward in reward_list -%}
                    {%- set reward_labels = reward.labels | default([], true) if reward is mapping else [] -%}
                    {%- if reward_labels | length == 0 -%}
                      {%- set ns.all_labels = ns.all_labels + ['-No Label-'] -%}
                    {%- else -%}
                      {%- set ns.all_labels = ns.all_labels + reward_labels -%}
                    {%- endif -%}
                  {%- endfor -%}
                  {%- set ns.all_labels = ns.all_labels | unique | list | sort -%}

                  {#-- Determine label order --#}
                  {%- if pref_label_display_order | length > 0 -%}
                    {#-- Start with custom order --#}
                    {%- set ns.label_order = pref_label_display_order -%}
                    {#-- Add remaining labels (excluding -No Label-) --#}
                    {%- set remaining = ns.all_labels | reject('in', pref_label_display_order) | reject('eq', '-No Label-') | list -%}
                    {%- set ns.label_order = ns.label_order + remaining -%}
                    {#-- Add -No Label- at the end ONLY if not already in custom order --#}
                    {%- if '-No Label-' in ns.all_labels and '-No Label-' not in pref_label_display_order -%}
                      {%- set ns.label_order = ns.label_order + ['-No Label-'] -%}
                    {%- endif -%}
                  {%- else -%}
                    {#-- Alphabetical order, but with -No Label- last --#}
                    {%- set ns.label_order = ns.all_labels | reject('eq', '-No Label-') | list -%}
                    {%- if '-No Label-' in ns.all_labels -%}
                      {%- set ns.label_order = ns.label_order + ['-No Label-'] -%}
                    {%- endif -%}
                  {%- endif -%}

                  {%- set ns.label_order = ns.label_order | reject('in', pref_exclude_label_list) | list -%}

                  {#-- Build label groups --#}
                  {%- for label in ns.label_order -%}
                    {%- set ns.temp_label_rewards = [] -%}
                    {%- for reward in reward_list -%}
                      {%- set reward_labels = reward.labels | default([], true) if reward is mapping else [] -%}
                      {%- set reward_label_check = reward_labels if reward_labels | length > 0 else ['-No Label-'] -%}
                      {%- if label in reward_label_check -%}
                        {%- set ns.temp_label_rewards = ns.temp_label_rewards + [reward] -%}
                      {%- endif -%}
                    {%- endfor -%}
                    {%- if ns.temp_label_rewards | length > 0 -%}
                      {%- set ns.label_groups = ns.label_groups + [{'name': label, 'rewards': ns.temp_label_rewards, 'icon': 'mdi:gift'}] -%}
                    {%- endif -%}
                  {%- endfor -%}
                {%- endif -%}

                {#-- If no groups (grouping disabled or no labels), create single group --#}
                {%- if ns.label_groups | length == 0 and reward_list | length > 0 -%}
                  {%- set ns.label_groups = [{'name': ui.get('rewards', 'err-rewards'), 'rewards': reward_list, 'icon': 'mdi:gift'}] -%}
                {%- endif -%}

                {#-- Apply sorting to each group --#}
                {%- if pref_sort_rewards != 'default' -%}
                  {%- set ns.sorted_groups = [] -%}
                  {%- for group in ns.label_groups -%}
                    {%- if pref_sort_rewards in ['name_asc', 'name_desc'] -%}
                      {#-- Sort by reward name --#}
                      {%- set ns.temp_list = [] -%}
                      {%- for reward in group.rewards -%}
                        {%- set reward_name = (reward.name | default('zzz') | lower) if reward is mapping else 'zzz' -%}
                        {%- set ns.temp_list = ns.temp_list + [[reward_name, reward]] -%}
                      {%- endfor -%}
                      {%- set sorted_list = ns.temp_list | sort -%}
                      {%- if pref_sort_rewards == 'name_desc' -%}
                        {%- set sorted_list = sorted_list | reverse | list -%}
                      {%- endif -%}
                      {%- set sorted_rewards = sorted_list | map('last') | list -%}
                      {%- set ns.sorted_groups = ns.sorted_groups + [{'name': group.name, 'rewards': sorted_rewards, 'icon': group.icon}] -%}
                    {%- elif pref_sort_rewards in ['cost_asc', 'cost_desc'] -%}
                      {#-- Sort by reward cost --#}
                      {%- set ns.temp_list = [] -%}
                      {%- for reward in group.rewards -%}
                        {%- set reward_cost = (reward.cost | int(default=999999)) if reward is mapping else 999999 -%}
                        {%- set ns.temp_list = ns.temp_list + [[reward_cost, reward]] -%}
                      {%- endfor -%}
                      {%- set sorted_list = ns.temp_list | sort -%}
                      {%- if pref_sort_rewards == 'cost_desc' -%}
                        {%- set sorted_list = sorted_list | reverse | list -%}
                      {%- endif -%}
                      {%- set sorted_rewards = sorted_list | map('last') | list -%}
                      {%- set ns.sorted_groups = ns.sorted_groups + [{'name': group.name, 'rewards': sorted_rewards, 'icon': group.icon}] -%}
                    {%- else -%}
                      {#-- Unknown sort option, keep original group --#}
                      {%- set ns.sorted_groups = ns.sorted_groups + [group] -%}
                    {%- endif -%}
                  {%- endfor -%}
                  {%- set ns.label_groups = ns.sorted_groups -%}
                {%- endif -%}

                {#-- 5. Render --#}
                {%- if ns.label_groups | length == 0 -%}
                  {{
                    {
                      'type': 'heading',
                      'icon': 'mdi:gift-outline',
                      'heading': ui.get('rewards', 'err-rewards'),
                      'heading_style': 'title',
                    }
                  }},{{
                    {
                      'type': 'markdown',
                      'content': ui.get('no_rewards', 'err-no_rewards')
                    }
                  }},
                {%- else -%}
                  {%- for group in ns.label_groups -%}
                    {%- set ns.group_cards = [] -%}

                    {%- for reward in group.rewards -%}
                      {%- set reward_name = reward.name if reward is mapping else 'Unknown' -%}
                      {%- set reward_cost = (reward.cost | int(default=0)) if reward is mapping else 0 -%}
                      {%- set reward_claims = (reward.claims | int(default=0)) if reward is mapping else 0 -%}
                      {%- set reward_approvals = (reward.approvals | int(default=0)) if reward is mapping else 0 -%}
                      {%- set reward_sensor_eid = reward.eid if reward is mapping else '' -%}
                      {%- set claim_button_eid = state_attr(reward_sensor_eid, 'claim_button_eid') | default('', true) -%}

                      {%- set points_needed = reward_cost - current_points if reward_cost > current_points else 0 -%}
                      {%- set can_claim = "‚úÖ" if points_needed == 0 else "‚ùå " ~ ui.get('need', 'err-need') ~ " " ~ points_needed ~ " " ~ ui.get('more', 'err-more') -%}

                      {%- set ns.group_cards = ns.group_cards + [{
                        'type': 'custom:mushroom-template-card',
                        'entity': reward_sensor_eid,
                        'primary': reward_name,
                        'secondary': "üí∞ " ~ ui.get('cost', 'err-cost') ~ ": " ~ reward_cost|string ~ " | üëç " ~ reward_approvals|string ~ " | üì• " ~ reward_claims|string ~ " | " ~ can_claim,
                        'icon': 'mdi:gift',
                        'icon_color': 'green' if points_needed == 0 else 'grey',
                        'tap_action': { 'action': 'call-service', 'service': 'button.press', 'target': {'entity_id': claim_button_eid } },
                        'hold_action': { 'action': 'more-info' }
                      }] -%}
                    {%- endfor -%}

                    {{
                      {
                        'type': 'heading',
                        'icon': group.icon,
                        'heading': group.name,
                        'heading_style': 'title',
                      }
                    }},{{
                      {
                        'type': 'grid',
                        'columns': pref_column_count,
                        'square': false,
                        'cards': ns.group_cards if ns.group_cards | length > 0 else [{'type': 'markdown', 'content': ui.get('no_rewards', 'err-no_rewards')}]
                      }
                    }},
                  {%- endfor -%}
                {%- endif -%}
  - type: grid
    cards:
      - square: false
        type: grid
        columns: 1
        cards:
          - type: custom:auto-entities
            card:
              square: false
              type: grid
              columns: 1
            card_param: cards
            filter:
              template: >-
                {#-- ===== SHOWCASE CARD ===== --#}

                {#-- 1. User Configuration --#}
                {%- set Kid_name = 'Kidname' -%}
                {%- set pref_show_penalties = true -%}

                {#-- 2. Initialize Variables --#}
                {%- set Kid_name_normalize = Kid_name | slugify() -%}
                {%- set dashboard_helper = 'sensor.kc_' ~ Kid_name_normalize ~ '_ui_dashboard_helper' -%}
                {%- set points_sensor = 'sensor.kc_' ~ Kid_name_normalize ~ '_points' -%}
                {%- set points_icon = state_attr(points_sensor, 'icon') -%}
                {%- set points_label = state_attr(points_sensor, 'unit_of_measurement') -%}
                {%- set all_time_sensor = 'sensor.kc_' ~ Kid_name_normalize ~ '_chores_completed_total' -%}
                {%- set highest_badge_entity = 'sensor.kc_' ~ Kid_name_normalize ~ '_highest_badge' -%}

                {%- set ns = namespace(
                  badge_list="\n ",
                  reward_progress=[],
                  total_bonus_points=0,
                  bonuses=[],
                  total_penalty_points=0,
                  penalties=[],
                  achievements=[],
                  challenges=[],
                  content=''
                ) -%}

                {#-- 3. Collect Data --#}
                {%- set ui = state_attr(dashboard_helper, 'ui_translations') or {} -%}
                {%- set points = states(points_sensor) | int(default=0) -%}
                {%- set points_earned_all_time = state_attr(points_sensor, 'point_stat_points_earned_all_time') | int(default=0) -%}
                {%- set all_time_completed = states(all_time_sensor) | int(default=0) -%}
                {%- set highest_badge = states(highest_badge_entity) or 'None' -%}
                {%- set highest_badge_icon = state_attr(highest_badge_entity, 'icon') or 'mdi:medal-outline' -%}
                {%- set highest_badge_multiplier = (state_attr(highest_badge_entity, 'awards') or {}).get('points_multiplier') | float(1) -%}
                {%- set all_badges = state_attr(highest_badge_entity, 'all_earned_badges') | default([], true) -%}
                {%- set reward_status_entities = state_attr(dashboard_helper, 'rewards') | default([], true) -%}
                {%- set bonus_list = state_attr(dashboard_helper, 'bonuses') | default([], true) -%}
                {%- set penalty_list = state_attr(dashboard_helper, 'penalties') | default([], true) -%}
                {#-- 4. Build Display --#}
                {%- set badge_display_line = ui.get('none', 'err-none') if highest_badge in ['None', 'unknown', 'Unknown', 'unavailable'] else "<ha-icon icon='" ~ highest_badge_icon ~ "'></ha-icon> " ~ highest_badge -%}

                {%- for badge in all_badges -%}
                  {%- set badge_name_normalize = badge | slugify() -%}
                  {%- set badge_entity = 'sensor.kc_' ~ badge_name_normalize ~ '_badge' -%}
                  {%- set badge_icon = state_attr(badge_entity, 'icon') | default('mdi:medal-outline') -%}
                  {%- set ns.badge_list = ns.badge_list + "- <ha-icon icon='" ~ badge_icon ~ "'></ha-icon> " ~ badge ~ "  \n" -%}
                {%- endfor -%}

                {%- for reward in reward_status_entities -%}
                  {%- set reward_name = (reward.name | default('Unknown Reward')) if reward is mapping else 'Unknown Reward' -%}
                  {%- set claim_count = (reward.claims | int(default=0)) if reward is mapping else 0 -%}
                  {%- set approval_count = (reward.approvals | int(default=0)) if reward is mapping else 0 -%}
                  {%- if claim_count > 0 or approval_count > 0 -%}
                    {%- set ns.reward_progress = ns.reward_progress + [
                      "- üéÅ **" ~ reward_name ~ ":** &nbsp;&nbsp; " ~ ui.get('claims', 'err-claims') ~ ": &nbsp;"
                      ~ claim_count ~ "&nbsp; |&nbsp; " ~ ui.get('approvals', 'err-approvals') ~ ": &nbsp;" ~ approval_count
                    ] -%}
                  {%- endif -%}
                {%- endfor -%}

                {%- for bonus in bonus_list -%}
                  {%- set bonus_sensor = bonus.eid if bonus is mapping else bonus -%}
                  {%- set bonus_name = state_attr(bonus_sensor, 'bonus_name') | default('Unknown Bonus') -%}
                  {%- set bonus_icon = state_attr(bonus_sensor, 'icon') | default('mdi:alert') -%}
                  {%- set bonus_points = state_attr(bonus_sensor, 'bonus_points') | float(default=0) -%}
                  {%- set bonus_count = states(bonus_sensor) | int(default=0) -%}
                  {%- if bonus_count > 0 -%}
                    {%- set ns.total_bonus_points = ns.total_bonus_points + (bonus_points * bonus_count) -%}
                    {%- set ns.bonuses = ns.bonuses + [
                      "- <ha-icon icon='" ~ bonus_icon ~ "'></ha-icon> **" ~ bonus_name ~ ":** " ~ ui.get('applied', 'err-applied') ~ " "
                      ~ bonus_count ~ " (üí∞ " ~ (bonus_points * bonus_count) ~ " " ~ points_label ~ ")"
                    ] -%}
                  {%- endif -%}
                {%- endfor -%}

                {%- for penalty in penalty_list -%}
                  {%- set penalty_sensor = penalty.eid if penalty is mapping else penalty -%}
                  {%- set penalty_name = state_attr(penalty_sensor, 'penalty_name') | default('Unknown Penalty') -%}
                  {%- set penalty_icon = state_attr(penalty_sensor, 'icon') | default('mdi:alert') -%}
                  {%- set penalty_points = state_attr(penalty_sensor, 'penalty_points') | float(default=0) -%}
                  {%- set penalty_count = states(penalty_sensor) | int(default=0) -%}
                  {%- if penalty_count > 0 -%}
                    {%- set ns.total_penalty_points = ns.total_penalty_points + (-penalty_points * penalty_count) -%}
                    {%- set ns.penalties = ns.penalties + [
                      "- <ha-icon icon='" ~ penalty_icon ~ "'></ha-icon> **" ~ penalty_name ~ ":** " ~ ui.get('applied', 'err-applied') ~ " "
                      ~ penalty_count ~ " (üí• " ~ (-penalty_points * penalty_count) ~ " " ~ points_label ~ ")"
                    ] -%}
                  {%- endif -%}
                {%- endfor -%}

                {#-- Collect Achievements with Progress and Rewards --#} {#--
                Use Dashboard Helper for Achievements --#} {%- set
                achievement_list = state_attr(dashboard_helper, 'achievements')
                | default([], true) -%} {%- for achievement in achievement_list
                -%}
                  {%- set achievement_sensor = achievement.eid if achievement is mapping else achievement -%}
                  {%- set name = state_attr(achievement_sensor, 'achievement_name') | default('Unknown Achievement') -%}
                  {%- set icon = state_attr(achievement_sensor, 'icon') or 'mdi:trophy-award' -%}
                  {%- set progress = states(achievement_sensor) | float(default=0) -%}
                  {%- set award_status = state_attr(achievement_sensor, 'awarded') -%}

                  {#-- Get Overall Sensor for Reward Points --#}
                  {%- set overall_sensor = achievement_sensor | regex_replace('^sensor\\.kc_.*?_achievement_status_', 'sensor.kc_achievement_status_') -%}

                  {%- set reward_points = state_attr(overall_sensor, 'reward_points') | int(default=0) -%}

                  {%- set status = ui.get('completed', 'err-completed') if award_status == 'true' else '‚åõ ' ~ progress|round(0) ~ '%' -%}
                  {%- set ns.achievements = ns.achievements + ["- " ~ "<ha-icon icon='" ~ icon ~ "'></ha-icon>&nbsp;" ~ name ~ " (" ~ status ~ ", üíé " ~ reward_points ~ ")"] -%}
                {%- endfor -%}

                {#-- Collect Challenges with Progress and Rewards --#} {#-- Use
                Dashboard Helper for Challenges --#} {%- set challenge_list =
                state_attr(dashboard_helper, 'challenges') | default([], true)
                -%} {%- for challenge in challenge_list -%}
                  {%- set challenge_sensor = challenge.eid if challenge is mapping else challenge -%}
                  {%- set name = state_attr(challenge_sensor, 'challenge_name') | default('Unknown Challenge') -%}
                  {%- set icon = state_attr(challenge_sensor, 'icon') or 'mdi:flag-checkered' -%}
                  {%- set progress = states(challenge_sensor) | float(default=0) -%}
                  {%- set award_status = state_attr(challenge_sensor, 'awarded') -%}

                  {#-- Get Overall Sensor for Reward Points --#}
                  {%- set overall_sensor = challenge_sensor | regex_replace('^sensor\\.kc_.*?_achievement_status_', 'sensor.kc_achievement_status_') -%}
                  {%- set reward_points = state_attr(overall_sensor, 'reward_points') | int(default=0) -%}

                  {%- set status = "‚úîÔ∏è " ~ ui.get('completed', 'err-completed') if award_status == 'true' else '‚åõ ' ~ progress|round(0) ~ '%' -%}
                  {%- set ns.challenges = ns.challenges + ["- " ~ "<ha-icon icon='" ~ icon ~ "'></ha-icon>&nbsp;" ~ name ~ " (" ~ status ~ ", üíé " ~ reward_points ~ ")"] -%}
                {%- endfor -%}

                {#-- Create Content Variable --#}

                {%- set ns.content =
                  "## üèÖ " ~ Kid_name ~ "‚Äôs " ~ ui.get('showcase', 'err-showcase') ~ "  \n"
                  "<ha-icon icon=" ~ points_icon ~ "></ha-icon>" ~ "&nbsp;&nbsp;**" ~ points_label ~ ":** &nbsp;&nbsp;" ~ points ~ " \n\n"
                  "&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;**" ~ ui.get('earned_all_time', 'err-earned_all_time') ~ ":** &nbsp;&nbsp;" ~ points_earned_all_time ~ " \n\n"
                  "<ha-icon icon=" ~ 'mdi:broom' ~ "></ha-icon>" ~ "&nbsp;&nbsp;**" ~ ui.get('total_completed', 'err-total_completed') ~ ":** &nbsp;&nbsp;" ~ all_time_completed ~ " \n\n"
                  "**ü•á " ~ ui.get('highest_badge_earned', 'err-highest_badge_earned') ~ ":** &nbsp;&nbsp;" ~ badge_display_line ~ "  \n"
                  "**üíé " ~ points_label ~ " " ~ ui.get('multiplier', 'err-multiplier') ~ ":** &nbsp;&nbsp;x" ~ highest_badge_multiplier ~ "  \n\n"
                  "**ü•á " ~ ui.get('all_earned_badges', 'err-all_earned_badges') ~ ":**  " ~ (ns.badge_list if all_badges | length > 0 else "&nbsp;" ~ ui.get('none', 'err-none')) ~ "  \n"
                  "#### üéÅ " ~ ui.get('rewards', 'err-rewards') ~ ": &nbsp;&nbsp;" ~
                  ("\n" ~ ('\n'.join(ns.reward_progress)) if ns.reward_progress | length > 0 else ui.get('none', 'err-none')) ~ "  \n\n"
                  "#### ‚≠ê " ~ ui.get('bonuses_applied', 'err-bonuses_applied') ~ ": &nbsp;&nbsp;" ~
                  ("\n" ~ ('\n'.join(ns.bonuses)) ~ "  \n"
                  "**üí∞ " ~ ui.get('total_bonus', 'err-total_bonus') ~ " " ~ points_label ~ ":** &nbsp;&nbsp;" ~ ns.total_bonus_points ~ "  \n"
                  if ns.bonuses | length > 0 else ui.get('none', 'err-none')) ~ " \n"
                  -%}

                  {%- if pref_show_penalties -%}
                    {%- set ns.content = ns.content ~
                      "#### ‚ö†Ô∏è " ~ ui.get('penalties_applied', 'err-penalties_applied') ~ ": &nbsp;&nbsp;" ~
                      ("\n" ~ ('\n'.join(ns.penalties))  ~ "  \n"
                      "**üí• " ~ ui.get('total_penalty', 'err-total_penalty') ~ " " ~ points_label ~ ":** &nbsp;&nbsp;" ~ ns.total_penalty_points ~ "  \n"
                      if ns.penalties | length > 0 else ui.get('none', 'err-none')) ~ " \n"
                      -%}
                  {%- endif -%}


                  {%- set ns.content = ns.content ~
                  "#### üèÜ " ~ ui.get('achievements', 'err-achievements') ~ ": &nbsp;&nbsp; " ~
                  ('\n' ~ ('\n'.join(ns.achievements)) if ns.achievements | length > 0 else "&nbsp;" ~ ui.get('none', 'err-none')) ~ "  \n"
                  "#### üèÅ " ~ ui.get('challenges', 'err-challenges') ~ ": &nbsp;&nbsp; " ~
                  ('\n' ~ ('\n'.join(ns.challenges)) if ns.challenges | length > 0 else "&nbsp;" ~ ui.get('none', 'err-none')) ~ "  \n"
                -%}

                {{
                  {
                    'type': 'markdown',
                    'content': ns.content
                  }
                }},
      - type: custom:auto-entities
        card:
          square: false
          type: grid
          columns: 1
        card_param: cards
        filter:
          template: >-
            {#-- ===== CUMULATIVE BADGE CARD ===== --#}

            {#-- 1. User Configuration --#}
            {%- set Kid_name = 'Kidname' -%}

            {#-- 2. Initialize Variables --#}
            {%- set Kid_name_normalize = Kid_name | slugify() -%}
            {%- set dashboard_helper = 'sensor.kc_' ~ Kid_name_normalize ~ '_ui_dashboard_helper' -%}
            {%- set points_sensor = 'sensor.kc_' ~ Kid_name_normalize ~ '_points' -%}

            {%- set ns = namespace(
              badges=[],
              points=0,
              points_label='',
              highest_badge_sensor='',
              m_status='',
              m_cycle_pts=0,
              m_end_date='',
              m_grace_end='',
              m_remaining=0,
              m_required=0,
              m_last_awarded='',
              m_award_count=0,
              points_to_next=0,
              highest_earned_id='',
              lowest_unearned_id='',
              has_earned_any=false
            ) -%}

            {#-- 3. Collect Data --#}
            {%- set ui = state_attr(dashboard_helper, 'ui_translations') or {} -%}
            {%- set ns.points = states(points_sensor) | int(default=0) -%}
            {%- set ns.points_label = state_attr(points_sensor, 'unit_of_measurement') | default('Pts', true) -%}
            {%- set ns.highest_badge_sensor = 'sensor.kc_' ~ Kid_name_normalize ~ '_highest_badge' -%}
            {%- set hb_state = states(ns.highest_badge_sensor) -%}

            {#-- Extract Live Maintenance Details (if valid) --#}
            {%- if hb_state not in ['unknown', 'unavailable'] -%}
              {%- set ns.points_to_next = state_attr(ns.highest_badge_sensor, 'points_to_next_badge') | int(default=0) -%}
              {%- if ns.points_to_next is none -%}
                {%- set ns.points_to_next = 0 -%}
              {%- endif -%}
              {%- set ns.m_status = state_attr(ns.highest_badge_sensor, 'badge_status') | default('active') -%}
              {%- set ns.m_cycle_pts = state_attr(ns.highest_badge_sensor, 'cycle_points') | int(default=0) -%}
              {%- set ns.m_end_date = state_attr(ns.highest_badge_sensor, 'maintenance_end_date') -%}
              {%- set ns.m_grace_end = state_attr(ns.highest_badge_sensor, 'maintenance_grace_end_date') -%}
              {%- set ns.m_required = state_attr(ns.highest_badge_sensor, 'maintenance_points_required') | int(default=0) -%}
              {%- set ns.m_remaining = state_attr(ns.highest_badge_sensor, 'maintenance_points_remaining') | int(default=0) -%}
              {%- set ns.m_last_awarded = state_attr(ns.highest_badge_sensor, 'last_awarded_date') -%}
              {%- set ns.m_award_count = state_attr(ns.highest_badge_sensor, 'award_count') | int(default=0) -%}
            {%- endif -%}

            {#-- Collect Badge Sensors: Three badges from highest_badge sensor --#}
            {%- set hb_current_name = (states(ns.highest_badge_sensor) or state_attr(ns.highest_badge_sensor, 'current_badge_name') or state_attr(ns.highest_badge_sensor, 'highest_earned_badge_name')) | default('') -%}
            {%- set hb_next_higher_name = state_attr(ns.highest_badge_sensor, 'next_higher_badge_name') | default('') -%}
            {%- set hb_next_lower_name = state_attr(ns.highest_badge_sensor, 'next_lower_badge_name') | default('') -%}
            {%- set target_names = [hb_current_name, hb_next_higher_name, hb_next_lower_name] -%}

            {#-- Process each badge and build badge list --#}
            {%- for bname in target_names -%}
              {%- if bname and bname not in ['None', 'unknown', 'unavailable'] -%}
                {%- set badge_name_normalize = bname | slugify() -%}
                {%- set badge_entity = 'sensor.kc_' ~ badge_name_normalize ~ '_badge' -%}
                {%- if states(badge_entity) not in ['unknown', 'unavailable'] -%}
                  {#-- Extract badge details --#}
                  {%- set target_data = state_attr(badge_entity, 'target') -%}
                  {%- set threshold_val = 0 -%}
                  {%- set maintenance_points = 0 -%}
                  {%- if target_data is mapping -%}
                    {%- set threshold_val = target_data.threshold_value | float(default=0) -%}
                    {%- set maintenance_points = target_data.maintenance_rules | int(default=0) -%}
                  {%- else -%}
                    {%- set threshold_val = state_attr(badge_entity, 'threshold_value') | float(default=0) -%}
                  {%- endif -%}

                  {#-- Extract awards --#}
                  {%- set awards_data = state_attr(badge_entity, 'awards') -%}
                  {%- set award_items_list = [] -%}
                  {%- if awards_data is iterable and awards_data is not string and awards_data is not none -%}
                    {%- set award_items_list = awards_data -%}
                  {%- endif -%}

                  {#-- Extract kids earned --#}
                  {%- set raw_earned = state_attr(badge_entity, 'kids_earned') -%}
                  {%- set earned_list = [] -%}
                  {%- if raw_earned is string -%}
                    {%- set earned_list = [raw_earned] -%}
                  {%- elif raw_earned is iterable and raw_earned is not string and raw_earned is not none -%}
                    {%- set earned_list = raw_earned -%}
                  {%- endif -%}

                  {#-- Build badge info --#}
                  {%- set badge_info = {
                    'entity_id': badge_entity,
                    'name': (state_attr(badge_entity, 'friendly_name') | default(bname)) | regex_replace('^Badge - ', ''),
                    'icon': state_attr(badge_entity, 'icon') | default('mdi:medal-outline'),
                    'description': state_attr(badge_entity, 'description') | default(''),
                    'type': ui.get('cumulative', 'err-cumulative'),
                    'threshold': threshold_val,
                    'award_items': award_items_list,
                    'kids_earned': earned_list,
                    'maintenance': maintenance_points,
                    'badge_id': state_attr(badge_entity, 'badge_id') | default('')
                  } -%}
                  {%- set ns.badges = ns.badges + [badge_info] -%}

                  {#-- Map highest/lowest badge IDs for tracking --#}
                  {%- if state_attr(ns.highest_badge_sensor, 'current_badge_id') and state_attr(ns.highest_badge_sensor, 'current_badge_id') == badge_info.badge_id -%}
                    {%- set ns.highest_earned_id = badge_entity -%}
                    {%- set ns.has_earned_any = true -%}
                  {%- elif state_attr(ns.highest_badge_sensor, 'current_badge_name') and state_attr(ns.highest_badge_sensor, 'current_badge_name') == badge_info.name -%}
                    {%- set ns.highest_earned_id = badge_entity -%}
                    {%- set ns.has_earned_any = true -%}
                  {%- endif -%}

                  {%- if state_attr(ns.highest_badge_sensor, 'next_higher_badge_id') and state_attr(ns.highest_badge_sensor, 'next_higher_badge_id') == badge_info.badge_id -%}
                    {%- set ns.lowest_unearned_id = badge_entity -%}
                  {%- elif state_attr(ns.highest_badge_sensor, 'next_higher_badge_name') and state_attr(ns.highest_badge_sensor, 'next_higher_badge_name') == badge_info.name -%}
                    {%- set ns.lowest_unearned_id = badge_entity -%}
                  {%- endif -%}
                {%- endif -%}
              {%- endif -%}
            {%- endfor -%}

            {#-- 4. Build Display --#}
            {%- set sorted_badges = ns.badges | sort(reverse=true, attribute='threshold') -%}

            {#-- 5. Render --#}
            {%- if sorted_badges | length == 0 -%}
              {{
                {
                  'type': 'markdown',
                  'content': "### üèÖ " ~ ui.get('no_badges_found', 'err-no_badges_found') ~ " \n" ~ ui.get('badge_setup_prompt', 'err-badge_setup_prompt')
                }
              }},
            {%- else -%}
              {%- for badge in sorted_badges -%}
                {%- set earned = ns.Kid_name in badge.kids_earned -%}
                {%- set is_highest_earned = (badge.entity_id == ns.highest_earned_id) -%}
                {%- set is_target_card = (badge.entity_id == ns.lowest_unearned_id) -%}

                {#-- HEADER --#}
                {%- set content = "## <ha-icon icon=" ~ badge.icon ~ "></ha-icon> " ~ badge.name ~ " \n" -%}

                {%- if badge.description -%}
                  {%- set content = content ~ "_" ~ badge.description ~ "_  \n" -%}
                {%- else -%}
                  {%- set content = content ~ "_" ~ badge.type ~ " " ~ ui.get('badge', 'err-badge') ~ "_  \n" -%}
                {%- endif -%}

                {#-- STATUS --#}
                {%- if earned -%}
                    {%- set content = content ~ "üèÖ **" ~ ui.get('status', 'err-status') ~ ":** ‚úÖ " ~ ui.get('earned', 'err-earned') ~ "  \n" -%}
                {%- else -%}
                    {%- set content = content ~ "üèÖ **" ~ ui.get('status', 'err-status') ~ ":** üîí " ~ ui.get('future_goal', 'err-future_goal') ~ "  \n" -%}
                {%- endif -%}

                {#-- AWARD COUNT & LAST AWARDED (Only for Highest Earned Badge) --#}
                {%- if is_highest_earned -%}
                    {%- if ns.m_award_count > 0 or ns.m_last_awarded -%}
                        {%- if ns.m_last_awarded -%}
                            {%- set content = content ~ "‚≠ê **" ~ ui.get('last_earned', 'err-last_earned') ~ ":** " ~ ns.m_last_awarded ~ "  \n" -%}
                        {%- endif -%}
                        {%- if ns.m_award_count > 0 -%}
                            {%- set content = content ~ "üéñÔ∏è **" ~ ui.get('earned_count', 'err-earned_count') ~ ":** " ~ ns.m_award_count ~ "  \n" -%}
                        {%- endif -%}
                    {%- endif -%}
                {%- endif -%}

                {#-- THRESHOLD --#}
                {%- set content = content ~ "\n---\n" -%}
                {%- set content = content ~ "üéØ **" ~ ui.get('threshold', 'err-threshold') ~ ":** " ~ badge.threshold|int ~ " " ~ ns.points_label ~ "  \n" -%}

                {#-- AWARDS SECTION --#}
                {%- if badge.award_items | length > 0 -%}
                    {%- set content = content ~ "üíé **" ~ ui.get('awards', 'err-awards') ~ ":** " ~ badge.award_items | join(', ') ~ "  \n" -%}
                {%- endif -%}

                {#-- MIDDLE: LIVE MAINTENANCE (Only for Highest Earned Badge) --#}
                {%- if is_highest_earned -%}
                    {%- if ns.m_required > 0 or badge.maintenance > 0 -%}
                        {%- set content = content ~ "\n---\n" -%}
                        {%- set content = content ~ "#### üîÑ **" ~ ui.get('maintenance', 'err-maintenance') ~ ":** " -%}

                        {#- Status Line -#}
                        {%- if ns.m_status == 'active' -%}
                            {%- set content = content ~ " üü¢ " ~ ui.get('active', 'err-active') ~ " \n" -%}
                        {%- elif ns.m_status == 'demoted'-%}
                            {%- set content = content ~ "‚ö†Ô∏è " ~ ui.get('demoted', 'err-demoted') ~ "  \n" -%}
                        {%- else -%}
                            {%- set content = content ~ "‚ö†Ô∏è " ~ ns.m_status|title ~ "  \n" -%}
                        {%- endif -%}

                        {#- Progress Line -#}
                        {%- set req_pts = ns.m_required if ns.m_required > 0 else badge.maintenance -%}
                        {%- set content = content ~ "- ‚è≥ **" ~ ui.get('in_progress', 'err-in_progress') ~ ":** " ~ ns.m_cycle_pts ~ " / " ~ req_pts ~ " " ~ ns.points_label ~ "  \n" -%}

                        {%- if ns.m_remaining > 0 -%}
                            {%- set content = content ~ "- üî• **" ~ ui.get('need', 'err-need') ~ ":** " ~ ns.m_remaining ~ " " ~ ns.points_label ~ "  \n" -%}
                        {%- else -%}
                            {%- set content = content ~ "- üéâ " ~ ui.get('requirement_met', 'err-requirement_met') ~ " \n" -%}
                        {%- endif -%}

                        {#- Dates -#}
                        {%- if ns.m_end_date -%}
                            {%- set content = content ~ "- üìÖ **" ~ ui.get('due', 'err-due') ~ ":** " ~ ns.m_end_date ~ "  \n" -%}
                        {%- endif -%}
                        {%- if ns.m_grace_end -%}
                            {%- set content = content ~ "- üöë **" ~ ui.get('grace_period', 'err-grace_period') ~ ":** " ~ ns.m_grace_end ~ "  \n" -%}
                        {%- endif -%}
                    {%- endif -%}
                {%- endif -%}

                {#-- FOOTER: POINTS TO NEXT + EARNED BY --#}
                {%- set footer_elements = [] -%}

                {#-- 1. Add "Points to Next" on the Target Card (Lowest Unearned) --#}
                {%- if is_target_card -%}
                    {%- set pts_val = 0 -%}

                    {#- SCENARIO A: User has earned badges. Use Sensor Data. -#}
                    {%- if ns.has_earned_any -%}
                        {%- set pts_val = ns.points_to_next -%}

                    {#- SCENARIO B: User has NO earned badges. Calculate manually. -#}
                    {%- else -%}
                        {%- set pts_val = (badge.threshold - ns.points) | int -%}
                        {%- if pts_val < 0 -%} {%- set pts_val = 0 -%} {%- endif -%}
                    {%- endif -%}

                    {%- if pts_val > 0 -%}
                        {%- set footer_elements = footer_elements + ["üöÄ **" ~ ui.get('to_unlock', 'err-to_unlock') ~ ":** " ~ pts_val ~ " " ~ ns.points_label] -%}
                    {%- endif -%}
                {%- endif -%}

                {#-- 2. Add "Earned By" if applicable (Any card) --#}
                {%- if badge.kids_earned | length > 0 -%}
                    {%- set footer_elements = footer_elements + ["üë• **" ~ ui.get('earned_by', 'err-earned_by') ~ ":** " ~ badge.kids_earned | join(', ')] -%}
                {%- endif -%}

                {#-- Render Footer if elements exist --#}
                {%- if footer_elements | length > 0 -%}
                    {%- set content = content ~ "\n---\n" ~ footer_elements | join("  \n") -%}
                {%- endif -%}

                {{
                  {
                    'type': 'markdown',
                    'content': content
                  }
                }},
              {%- endfor -%}
            {%- endif -%}
      - type: custom:auto-entities
        card:
          square: false
          type: grid
          columns: 1
        card_param: cards
        filter:
          template: >-
            {#-- ===== GENERAL BADGE CARD ===== --#}

            {#-- 1. User Configuration --#}
            {%- set Kid_name = 'Kidname' -%}

            {#-- 2. Initialize Variables --#}
            {%- set Kid_name_normalize = Kid_name | slugify() -%}
            {%- set dashboard_helper = 'sensor.kc_' ~ Kid_name_normalize ~ '_ui_dashboard_helper' -%}
            {%- set points_sensor = 'sensor.kc_' ~ Kid_name_normalize ~ '_points' -%}

            {%- set ns = namespace(
              badges=[]
            ) -%}

            {#-- 3. Collect Data --#}
            {%- set ui = state_attr(dashboard_helper, 'ui_translations') or {} -%}
            {%- set points = states(points_sensor) | int(default=0) -%}
            {%- set points_label = state_attr(points_sensor, 'unit_of_measurement') | default('Pts', true) -%}

            {%- set badge_list = state_attr(dashboard_helper, 'badges') | default([], true) -%}
            {%- for badge in badge_list -%}
              {%- set badge_sensor_id = badge.eid if badge is mapping else badge -%}

              {#-- Filter by Assigned Kids --#}
              {%- set assigned = state_attr(badge_sensor_id, 'kids_assigned') -%}
              {%- if assigned is iterable and assigned is not string and assigned | length > 0 and Kid_name not in assigned -%}
                {%- continue -%}
              {%- endif -%}

              {%- set badge_info = {
                'entity_id': badge_sensor_id,
                'name': state_attr(badge_sensor_id, 'name') | default('Unknown Badge'),
                'icon': state_attr(badge_sensor_id, 'icon') | default('mdi:medal-outline'),
                'description': state_attr(badge_sensor_id, 'description') | default(''),
                'type': state_attr(badge_sensor_id, 'badge_type') | default('unknown'),
                'status': state_attr(badge_sensor_id, 'status') | default('in_progress'),
                'progress': states(badge_sensor_id) | float(default=0),
                'start_date': state_attr(badge_sensor_id, 'start_date'),
                'end_date': state_attr(badge_sensor_id, 'end_date'),
                'award_count': state_attr(badge_sensor_id, 'award_count') | int(default=0),
                'last_awarded': state_attr(badge_sensor_id, 'last_awarded_date')
              } -%}
              {%- set ns.badges = ns.badges + [badge_info] -%}
            {%- endfor -%}

            {#-- 4. Build Display --#}
            {%- set sorted_badges = ns.badges | sort(attribute='name') -%}

            {#-- 5. Render --#}
            {%- if sorted_badges | length == 0 -%}
              {{
                {
                  'type': 'markdown',
                  'content': "### üèÖ " ~ ui.get('no_badges_found', 'err-no_badges_found') ~ " \n" ~ ui.get('badge_setup_prompt', 'err-badge_setup_prompt')
                }
              }},
            {%- else -%}
              {%- for badge in sorted_badges -%}

                {#-- HEADER --#}
                {%- set content = "## <ha-icon icon=" ~ badge.icon ~ "></ha-icon> " ~ badge.name ~ " \n" -%}

                {%- if badge.description -%}
                  {%- set content = content ~ "_" ~ badge.description ~ "_  \n" -%}
                {%- endif -%}

                {#-- STATUS LINE --#}
                {%- if badge.status == 'earned' -%}
                  {%- set content = content ~ "üèÖ **" ~ ui.get('status', 'err-status') ~ ":** ‚úÖ " ~ ui.get('earned', 'err-earned') ~ "  \n" -%}
                {%- elif badge.status == 'in_progress' -%}
                  {%- set content = content ~ "üèÖ **" ~ ui.get('status', 'err-status') ~ ":** ‚è≥ " ~ ui.get('in_progress', 'err-in_progress') ~ "  \n" -%}
                {%- else -%}
                  {%- set content = content ~ "üèÖ **" ~ ui.get('status', 'err-status') ~ ":** üîí " ~ ui.get('locked', 'err-locked') ~ "  \n" -%}
                {%- endif -%}

                {#-- PROGRESS LINE --#}
                {%- set content = content ~ "üìä **" ~ ui.get('progress', 'err-progress') ~ ":** " ~ badge.progress|round(1) ~ "%  \n" -%}

                {#-- START DATE --#}
                {%- if badge.start_date -%}
                  {%- set content = content ~ "üìÖ **" ~ ui.get('start_date', 'err-start_date') ~ ":** " ~ badge.start_date ~ "  \n" -%}
                {%- endif -%}

                {#-- END DATE --#}
                {%- if badge.end_date -%}
                  {%- set content = content ~ "üìÖ **" ~ ui.get('end_date', 'err-end_date') ~ ":** " ~ badge.end_date ~ "  \n" -%}
                {%- endif -%}

                {#-- AWARD COUNT --#}
                {%- if badge.award_count > 0 -%}
                  {%- set content = content ~ "üéñÔ∏è **" ~ ui.get('award_count', 'err-award_count') ~ ":** " ~ badge.award_count ~ "  \n" -%}
                {%- endif -%}

                {#-- LAST AWARDED DATE --#}
                {%- if badge.last_awarded -%}
                  {%- set content = content ~ "‚≠ê **" ~ ui.get('last_awarded', 'err-last_awarded') ~ ":** " ~ badge.last_awarded ~ "  \n" -%}
                {%- endif -%}

                {{
                  {
                    'type': 'markdown',
                    'content': content
                  }
                }},
              {%- endfor -%}
            {%- endif -%}
      - square: false
        type: grid
        columns: 1
        cards:
          - type: custom:auto-entities
            card:
              square: false
              type: grid
              columns: 1
            card_param: cards
            filter:
              template: >-
                {#-- ===== ACHIEVEMENTS CARD ===== --#}

                {#-- 1. User Configuration --#}
                {%- set Kid_name = 'Kidname' -%}

                {#-- 2. Initialize Variables --#}
                {%- set Kid_name_normalize = Kid_name | slugify() -%}
                {%- set dashboard_helper = 'sensor.kc_' ~ Kid_name_normalize ~ '_ui_dashboard_helper' -%}
                {%- set points_sensor = 'sensor.kc_' ~ Kid_name_normalize ~ '_points' -%}

                {%- set ns = namespace(
                  STREAK_GOAL='Streak Goal',
                  TOTAL_CHORES='Total Chores',
                  DAILY_MINIMUM='Daily Minimum'
                ) -%}

                {#-- 3. Collect Data --#}
                {%- set ui = state_attr(dashboard_helper, 'ui_translations') or {} -%}
                {%- set points_label = state_attr(points_sensor, 'unit_of_measurement') -%}

                {%- set achievements = state_attr(dashboard_helper, 'achievements') | default([], true) -%}

                {#-- 4. Build Display --#}
                {#-- (No pre-processing needed) --#}

                {#-- 5. Render --#}
                {%- if achievements | length == 0 -%}
                  {{
                    {
                      'type': 'markdown',
                      'content': "### üèÜ " ~ ui.get('no_achievements_found', 'err-no_achievements_found') ~ "  \n" ~ ui.get('start_achievement_prompt', 'err-start_achievement')
                    }
                  }},
                {%- else -%}
                  {%- for achievement in achievements -%}
                    {%- set achievement_sensor_id = achievement.eid if achievement is mapping else achievement -%}
                    {%- set achievement_name = state_attr(achievement_sensor_id, 'achievement_name') | default('Unknown') -%}
                    {%- set achievement_icon = state_attr(achievement_sensor_id, 'icon') or 'mdi:flag-checkered' -%}
                    {%- set achievement_overall_sensor = achievement_sensor_id | regex_replace('^sensor\.kc_[a-zA-Z0-9_]+_achievement_status_', 'sensor.kc_achievement_status_') -%}
                    {%- set target_value = state_attr(achievement_sensor_id, 'target_value') | int(default=0) -%}
                    {%- set raw_progress = state_attr(achievement_sensor_id, 'raw_progress') | float(default=0) -%}
                    {%- set awarded = state_attr(achievement_sensor_id, 'awarded') | default(false) -%}
                    {%- set reward_points = state_attr(achievement_overall_sensor, 'reward_points') | int(default=0) -%}
                    {%- set achievement_type = state_attr(achievement_overall_sensor, 'type') | default('total_within_window') -%}
                    {%- set progress_percentage = ((raw_progress / target_value) * 100) | round(1) if target_value > 0 else 0 -%}
                    {%- set associated_chore = state_attr(achievement_sensor_id, 'associated_chore') | default('') -%}
                    {%- set description = state_attr(achievement_sensor_id, 'description') | default('') -%}
                    {%- set criteria = state_attr(achievement_sensor_id, 'criteria') | default('') -%}
                    {%- set assigned_kids = state_attr(achievement_sensor_id, 'assigned_kids') | default([], true) -%}

                    {%- set awarded_text = "‚úîÔ∏è " ~ ui.get('earned', 'err-earned') if awarded else "‚åõ " ~ ui.get('in_progress', 'err-in_progress') -%}
                    {%- set goal_type_label =
                      target_value ~ ' (' ~ ns.STREAK_GOAL ~ ')' if achievement_type == 'chore_streak'
                      else target_value ~ ' (' ~ ns.DAILY_MINIMUM ~ ')' if achievement_type == 'daily_minimum'
                      else target_value ~ ' (' ~ ns.TOTAL_CHORES ~ ')' -%}
                    {%- set kids_display = assigned_kids | join(', ') if assigned_kids | count > 0 else '' -%}

                    {%- set content = "## <ha-icon icon=" ~ achievement_icon ~ "></ha-icon> " ~ ui.get('achievement', 'err-achievement') ~ ": " ~ achievement_name ~ "  \n" -%}
                    {%- set content = content ~ "### üèÖ " ~ ui.get('award_status', 'err-award_status') ~ ": &nbsp;&nbsp;" ~ awarded_text ~ "  \n" -%}

                    {%- if description -%}
                      {%- set content = content ~ "#### üìñ &nbsp;&nbsp;" ~ description ~ "  \n" -%}
                    {%- endif -%}

                    {%- if criteria -%}
                      {%- set content = content ~ "**üìå " ~ ui.get('criteria', 'err-criteria') ~ ":** &nbsp;&nbsp;" ~ criteria ~ "  \n" -%}
                    {%- endif -%}

                    {%- set content = content ~ "**üéØ " ~ ui.get('goal', 'err-goal') ~ ":** &nbsp;&nbsp;" ~ goal_type_label ~ "  \n" -%}

                    {%- if reward_points > 0 -%}
                      {%- set content = content ~ "**üíé " ~ ui.get('reward', 'err-reward') ~ ":** &nbsp;&nbsp;" ~ reward_points|string ~ " " ~ points_label ~ " \n" -%}
                    {%- endif -%}

                    {%- set content = content ~ "\n **üìä " ~ ui.get('progress', 'err-progress') ~ ":** &nbsp;&nbsp;" ~ raw_progress|int|string ~ "/" ~ target_value|string ~ " (" ~ progress_percentage|string ~ "%)  \n" -%}

                    {%- if kids_display -%}
                      {%- set content = content ~ "**üë• " ~ ui.get('assigned_to', 'err-assigned_to') ~ ":** &nbsp;&nbsp;" ~ kids_display ~ "  \n" -%}
                    {%- endif -%}

                    {%- if associated_chore -%}
                      {%- set content = content ~ "**üõ† " ~ ui.get('related_chore', 'err-related_chore') ~ ":** &nbsp;&nbsp;" ~ associated_chore ~ "  \n" -%}
                    {%- endif -%}

                    {{
                      {
                        'type': 'markdown',
                        'content': content
                      }
                    }},
                  {%- endfor -%}
                {%- endif -%}
      - square: false
        type: grid
        columns: 1
        cards:
          - type: custom:auto-entities
            card:
              square: false
              type: grid
              columns: 1
            card_param: cards
            filter:
              template: >-
                {#-- ===== CHALLENGES CARD ===== --#}

                {#-- 1. User Configuration --#}
                {%- set Kid_name = 'Kidname' -%}

                {#-- 2. Initialize Variables --#}
                {%- set Kid_name_normalize = Kid_name | slugify() -%}
                {%- set dashboard_helper = 'sensor.kc_' ~ Kid_name_normalize ~ '_ui_dashboard_helper' -%}
                {%- set points_sensor = 'sensor.kc_' ~ Kid_name_normalize ~ '_points' -%}
                {%- set points_label = state_attr(points_sensor, 'unit_of_measurement') -%}

                {#-- 3. Collect Data --#}
                {%- set ui = state_attr(dashboard_helper, 'ui_translations') or {} -%}
                {%- set challenges = state_attr(dashboard_helper, 'challenges') | default([], true) -%}

                {#-- 4. Build Display --#}
                {#-- (No pre-processing needed) --#}

                {#-- 5. Render --#}
                {%- if challenges | length == 0 -%}
                  {{
                    {
                      'type': 'markdown',
                      'content': "### üèÅ " ~ ui.get('no_challenges_found', 'err-no_challenges_found') ~ "  \n" ~ ui.get('start_challenge_prompt', 'err-start_challenge')
                    }
                  }},
                {%- else -%}
                  {%- for challenge in challenges -%}
                    {%- set challenge_sensor_id = challenge.eid if challenge is mapping else challenge -%}
                    {%- set challenge_name = state_attr(challenge_sensor_id, 'challenge_name') | default('Unknown') -%}
                    {%- set challenge_icon = state_attr(challenge_sensor_id, 'icon') or 'mdi:flag-checkered' -%}
                    {%- set challenge_overall_sensor = challenge_sensor_id | regex_replace('^sensor\.kc_[a-zA-Z0-9_]+_challenge_status_', 'sensor.kc_challenge_status_') -%}
                    {%- set target_value = state_attr(challenge_sensor_id, 'target_value') | int(default=0) -%}
                    {%- set raw_progress = state_attr(challenge_sensor_id, 'raw_progress') | float(default=0) -%}
                    {%- set awarded = state_attr(challenge_sensor_id, 'awarded') | default(false) -%}
                    {%- set reward_points = state_attr(challenge_overall_sensor, 'reward_points') | int(default=0) -%}
                    {%- set challenge_type = state_attr(challenge_overall_sensor, 'type') | default('total_within_window') -%}
                    {%- set progress_percentage = ((raw_progress / target_value) * 100) | round(1) if target_value > 0 else 0 -%}
                    {%- set associated_chore = state_attr(challenge_sensor_id, 'associated_chore') | default('') -%}
                    {%- set description = state_attr(challenge_sensor_id, 'description') | default('') -%}
                    {%- set criteria = state_attr(challenge_sensor_id, 'criteria') | default('') -%}
                    {%- set assigned_kids = state_attr(challenge_sensor_id, 'assigned_kids') | default([], true) -%}

                    {%- set awarded_text = "‚úîÔ∏è " ~ ui.get('earned', 'err-earned') if awarded else "‚åõ " ~ ui.get('in_progress', 'err-in_progress') -%}
                    {%- set goal_type_label = target_value ~ ' (' ~ ui.get('total_chores', 'err-total_chores') ~ ')' if challenge_type == 'total_within_window' else target_value ~ ' (' ~ ui.get('per_day_goal', 'err-per_day_goal') ~ ')' -%}
                    {%- set kids_display = assigned_kids | join(', ') if assigned_kids | count > 0 else '' -%}

                    {%- set start_date_utc = state_attr(challenge_overall_sensor, 'start_date') -%}
                    {%- set end_date_utc = state_attr(challenge_overall_sensor, 'end_date') -%}
                    {%- set start_date = as_datetime(start_date_utc).astimezone().strftime('%b %d, %Y') if start_date_utc else 'N/A' -%}
                    {%- set end_date = as_datetime(end_date_utc).astimezone().strftime('%b %d, %Y') if end_date_utc else 'N/A' -%}

                    {%- set content = "## <ha-icon icon=" ~ challenge_icon ~ "></ha-icon> " ~ ui.get('challenge', 'err-challenge') ~ ": " ~ challenge_name ~ "  \n" -%}
                    {%- set content = content ~ "### üèÖ " ~ ui.get('award_status', 'err-award_status') ~ ": &nbsp;&nbsp;" ~ awarded_text ~ "  \n" -%}

                    {%- if description -%}
                      {%- set content = content ~ "#### üìñ &nbsp;&nbsp;" ~ description ~ "  \n" -%}
                    {%- endif -%}

                    {%- if criteria -%}
                      {%- set content = content ~ "**üìå " ~ ui.get('criteria', 'err-criteria') ~ ":** &nbsp;&nbsp;" ~ criteria ~ "  \n" -%}
                    {%- endif -%}

                    {%- set content = content ~ "**üéØ " ~ ui.get('goal', 'err-goal') ~ ":** &nbsp;&nbsp;" ~ goal_type_label ~ "  \n" -%}
                    {%- set content = content ~ "**üìÖ " ~ ui.get('start_date', 'err-start_date') ~ ":** &nbsp;&nbsp;" ~ start_date ~ "  \n" -%}
                    {%- set content = content ~ "**üìÖ " ~ ui.get('end_date', 'err-end_date') ~ ":** &nbsp;&nbsp;" ~ end_date ~ "  \n" -%}

                    {%- if reward_points > 0 -%}
                      {%- set content = content ~ "**üíé " ~ ui.get('reward', 'err-reward') ~ ":** &nbsp;&nbsp;" ~ reward_points|string ~ " " ~ points_label ~ " \n" -%}
                    {%- endif -%}

                    {%- set content = content ~ "\n **üìä " ~ ui.get('progress', 'err-progress') ~ ":** &nbsp;&nbsp;" ~ raw_progress|int|string ~ "/" ~ target_value|string ~ " (" ~ progress_percentage|string ~ "%)  \n" -%}

                    {%- if kids_display -%}
                      {%- set content = content ~ "**üë• " ~ ui.get('assigned_to', 'err-assigned_to') ~ ":** &nbsp;&nbsp;" ~ kids_display ~ "  \n" -%}
                    {%- endif -%}

                    {%- if associated_chore -%}
                      {%- set content = content ~ "**üõ† " ~ ui.get('related_chore', 'err-related_chore') ~ ":** &nbsp;&nbsp;" ~ associated_chore ~ "  \n" -%}
                    {%- endif -%}

                    {{
                      {
                        'type': 'markdown',
                        'content': content
                      }
                    }},
                  {%- endfor -%}
                {%- endif -%}
  - type: grid
    cards:
      - square: false
        type: grid
        columns: 1
        cards:
          - type: custom:auto-entities
            card:
              square: false
              type: grid
              columns: 1
            card_param: cards
            filter:
              template: >-
                {#-- ===== PARENT DASHBOARD CARD ===== --#}

                {#-- 1. User Configuration --#}
                {%- set Kid_name = 'Kidname' -%}

                {#-- 2. Initialize Variables --#}
                {%- set Kid_name_normalize = Kid_name | slugify() -%}
                {%- set dashboard_helper = 'sensor.kc_' ~ Kid_name_normalize ~ '_ui_dashboard_helper' -%}
                {%- set points_sensor = 'sensor.kc_' ~ Kid_name_normalize ~ '_points' -%}
                {%- set total_chores_sensor = 'sensor.kc_' ~ Kid_name_normalize ~ '_chores_completed_total' -%}

                {#-- 3. Collect Data --#}
                {%- set ui = state_attr(dashboard_helper, 'ui_translations') or {} -%}
                {%- set points = states(points_sensor) | int(default=0) -%}
                {%- set points_label = state_attr(points_sensor, 'unit_of_measurement') -%}
                {%- set points_icon = state_attr(points_sensor, 'icon') -%}
                {%- set todays_completed = state_attr(total_chores_sensor, 'chore_stat_approved_today') | int(default=0) -%}
                {%- set weekly_completed = state_attr(total_chores_sensor, 'chore_stat_approved_week') | int(default=0) -%}
                {%- set monthly_completed = state_attr(total_chores_sensor, 'chore_stat_approved_month') | int(default=0) -%}
                {%- set overdue_chores = state_attr(total_chores_sensor, 'chore_stat_current_overdue') | int(default=0) -%}

                {#-- 4. Build Display --#}
                {%- set content = "## üë®‚Äçüë©‚Äçüëß " ~ ui.get('parent_dashboard_for', 'err-parent_dashboard_for') ~ ": " ~ Kid_name ~ "  \n" -%}
                {%- set content = content ~ "<ha-icon icon=" ~ points_icon ~ "></ha-icon> **" ~ points_label ~ ":** &nbsp;&nbsp;" ~ points ~ "  \n" -%}
                {%- set content = content ~ "#### üìÖ " ~ ui.get('chores_completed', 'err-chores_completed') ~ ":  \n" -%}
                {%- set content = content ~ "- ‚òÄÔ∏è " ~ ui.get('today', 'err-todays_completed') ~ ": &nbsp;&nbsp;" ~ todays_completed ~ "  \n" -%}
                {%- set content = content ~ "- üìÖ " ~ ui.get('week', 'err-week') ~ ": &nbsp;&nbsp;" ~ weekly_completed ~ "  \n" -%}
                {%- set content = content ~ "- üóìÔ∏è " ~ ui.get('month', 'err-month') ~ ": &nbsp;&nbsp;" ~ monthly_completed ~ "  \n" -%}
                {%- set content = content ~ "- üö® " ~ ui.get('overdue_chores', 'err-overdue_chores') ~ ": &nbsp;&nbsp;" ~ overdue_chores ~ "  \n\n" -%}

                {#-- 5. Render --#}
                {{
                  {
                    'type': 'markdown',
                    'content': content
                  }
                }},
      - square: false
        type: grid
        columns: 1
        cards:
          - type: custom:auto-entities
            card:
              square: false
              type: grid
              columns: 1
            card_param: cards
            filter:
              template: >-
                {#-- ===== APPROVAL ACTIONS CARD ===== --#}

                {#-- 1. User Configuration --#}
                {%- set Kid_name = 'Kidname' -%}
                {%- set pref_column_count = 2 -%}

                {#-- 2. Initialize Variables --#}
                {%- set Kid_name_normalize = Kid_name | slugify() -%}
                {%- set dashboard_helper = 'sensor.kc_' ~ Kid_name_normalize ~ '_ui_dashboard_helper' -%}

                {%- set ns = namespace(
                  approve_chore_buttons=[],
                  approve_reward_buttons=[],
                  group_cards=[],
                  has_approvals='false'
                ) -%}

                {#-- 3. Collect Data --#}
                {%- set ui = state_attr(dashboard_helper, 'ui_translations') or {} -%}

                {%- set pending_chore_data = state_attr('sensor.kc_global_chore_pending_approvals', Kid_name) | default([], true) if states('sensor.kc_global_chore_pending_approvals') not in ['unavailable', 'unknown'] else state_attr('sensor.kc_pending_chore_approvals', Kid_name) | default([], true) if states('sensor.kc_pending_chore_approvals') not in ['unavailable', 'unknown'] else [] -%}

                {%- set pending_reward_data = state_attr('sensor.kc_global_reward_pending_approvals', Kid_name) | default([], true) if states('sensor.kc_global_reward_pending_approvals') not in ['unavailable', 'unknown'] else state_attr('sensor.kc_global_pending_reward_approvals', Kid_name) | default([], true) if states('sensor.kc_global_pending_reward_approvals') not in ['unavailable', 'unknown'] else state_attr('sensor.kc_pending_reward_approvals', Kid_name) | default([], true) if states('sensor.kc_pending_reward_approvals') not in ['unavailable', 'unknown'] else [] -%}

                {#-- 4. Build Display --#}
                {%- if pending_chore_data | count > 0 -%}
                  {%- for entry in pending_chore_data -%}
                    {%- set ap = entry.approve_button_eid | default('') -%}
                    {%- set dis = entry.disapprove_button_eid | default('') -%}
                    {%- set cname = entry.chore_name | default('') -%}

                    {%- if ap != '' -%}
                      {%- if ap not in (ns.approve_chore_buttons | map(attribute='eid') | list) -%}
                        {%- set ns.approve_chore_buttons = ns.approve_chore_buttons + [{'eid': ap, 'primary': ui.get('ok', 'err-ok') ~ ': ' ~ cname, 'icon': 'mdi:thumb-up', 'icon_color': 'green'}] -%}
                      {%- endif -%}
                    {%- endif -%}

                    {%- if dis != '' -%}
                      {%- if dis not in (ns.approve_chore_buttons | map(attribute='eid') | list) -%}
                        {%- set ns.approve_chore_buttons = ns.approve_chore_buttons + [{'eid': dis, 'primary': ui.get('no', 'err-no') ~ ': ' ~ cname, 'icon': 'mdi:thumb-down', 'icon_color': 'red'}] -%}
                      {%- endif -%}
                    {%- endif -%}
                  {%- endfor -%}
                {%- endif -%}

                {%- if pending_reward_data | count > 0 -%}
                  {%- for entry in pending_reward_data -%}
                    {%- set ap = entry.approve_button_eid | default('') -%}
                    {%- set dis = entry.disapprove_button_eid | default('') -%}
                    {%- set rname = entry.reward_name | default('') -%}

                    {%- if ap != '' -%}
                      {%- if ap not in (ns.approve_reward_buttons | map(attribute='eid') | list) -%}
                        {%- set ns.approve_reward_buttons = ns.approve_reward_buttons + [{'eid': ap, 'primary': ui.get('ok', 'err-ok') ~ ': ' ~ rname, 'icon': 'mdi:thumb-up', 'icon_color': 'green'}] -%}
                      {%- endif -%}
                    {%- endif -%}

                    {%- if dis != '' -%}
                      {%- if dis not in (ns.approve_reward_buttons | map(attribute='eid') | list) -%}
                        {%- set ns.approve_reward_buttons = ns.approve_reward_buttons + [{'eid': dis, 'primary': ui.get('no', 'err-no') ~ ': ' ~ rname, 'icon': 'mdi:thumb-down', 'icon_color': 'red'}] -%}
                      {%- endif -%}
                    {%- endif -%}
                  {%- endfor -%}
                {%- endif -%}

                {%- set button_groups = [
                    {'name': ui.get('chore_approvals', 'err-chore_approvals'), 'buttons': ns.approve_chore_buttons, 'icon': 'mdi:thumb-up-outline'},
                    {'name': ui.get('reward_approvals', 'err-reward_approvals'), 'buttons': ns.approve_reward_buttons, 'icon': 'mdi:thumb-up-outline'}
                ] -%}

                {#-- 5. Render --#}
                {%- for group in button_groups -%}
                  {%- set ns.group_cards = [] -%}

                  {%- if group.buttons | length > 0 -%}
                    {%- set heading_card = {
                      'type': 'heading',
                      'icon': group.icon,
                      'heading': group.name,
                      'heading_style': 'title'
                    } -%}

                    {%- for button in group.buttons -%}
                      {%- if button is mapping -%}
                        {%- set eid = button.eid -%}
                        {%- set primary = button.primary -%}
                        {%- set icon = button.icon -%}
                        {%- set icon_color = button.icon_color -%}
                      {%- endif -%}

                      {%- set ns.group_cards = ns.group_cards + [{
                        'type': 'custom:mushroom-template-card',
                        'entity': eid,
                        'primary': primary,
                        'icon': icon,
                        'layout': '',
                        'icon_color': icon_color,
                        'tap_action': {
                          'action': 'toggle'
                        },
                        'hold_action': {
                          'action': 'more-info'
                        }
                      }] -%}
                    {%- endfor -%}

                    {{- heading_card -}}, {{
                      {
                        'type': 'grid',
                        'columns': pref_column_count,
                        'square': false,
                        'cards': ns.group_cards
                      }
                    }},
                  {%- endif -%}
                {%- endfor -%}
      - square: false
        type: grid
        columns: 1
        cards:
          - type: custom:auto-entities
            card:
              square: false
              type: grid
              columns: 1
            card_param: cards
            filter:
              template: >-
                {#-- ===== ADMIN ACTIONS CARD ===== --#}

                {#-- 1. User Configuration --#}
                {%- set Kid_name = 'Kidname' -%}

                {#-- 2. Initialize Variables --#}
                {%- set Kid_name_normalize = Kid_name | slugify() -%}
                {%- set dashboard_helper = 'sensor.kc_' ~ Kid_name_normalize ~ '_ui_dashboard_helper' -%}
                {%- set points_sensor = 'sensor.kc_' ~ Kid_name_normalize ~ '_points' -%}
                {%- set chore_select_entity = 'select.kc_' ~ Kid_name_normalize ~ '_chore_list' -%}
                {%- set chore_sensor_id_prefix = 'sensor.kc_' ~ Kid_name_normalize ~ '_chore_status_' -%}

                {%- set ns = namespace(
                  chore_selected=states(chore_select_entity),
                  chore_selected_normalize='',
                  chore_sensor_id='',
                  current_status='',
                  global_status='',
                  shared_chore='',
                  chore_allow_multiple='',
                  recurrence='',
                  chore_value=0,
                  chore_icon='',
                  chore_description='',
                  chore_days=[],
                  chore_custom_freq_unit='',
                  chore_custom_freq_int='',
                  due_date_formatted='',
                  select_new_date_and_time_secondary='',
                  content=''
                ) -%}

                {#-- 3. Collect Data --#}
                {%- set ui = state_attr(dashboard_helper, 'ui_translations') or {} -%}
                {%- set points_label = state_attr(points_sensor, 'unit_of_measurement') -%}
                {%- set chore_list = state_attr(dashboard_helper, 'chores') | default([], true) -%}
                {%- set overdue_count = chore_list | selectattr('status', 'eq', 'overdue') | list | length -%}

                {%- if ns.chore_selected | lower not in ['none', 'unknown', 'unavailable', ''] -%}
                  {%- set ns.chore_selected_normalize = ns.chore_selected | slugify() -%}
                  {%- set ns.chore_sensor_id = chore_sensor_id_prefix ~ ns.chore_selected_normalize -%}
                  {%- set ns.current_status = states(ns.chore_sensor_id) | default('Unknown') -%}
                  {%- set ns.global_status = state_attr(ns.chore_sensor_id, 'global_state') | default('Unknown') -%}

                  {%- set state_map = {
                      'pending': ui.get('pending', 'err-pending'),
                      'claimed': ui.get('claimed', 'err-claimed'),
                      'approved': ui.get('approved', 'err-approved'),
                      'overdue': ui.get('overdue', 'err-overdue')
                  } -%}

                  {%- set current_status_display = state_map[ns.current_status] if ns.current_status in state_map else ns.current_status -%}
                  {%- set global_status_display = state_map[ns.global_status] if ns.global_status in state_map else ns.global_status -%}
                  {%- set ns.shared_chore = state_attr(ns.chore_sensor_id, 'shared_chore') | string | default('False') -%}
                  {%- set ns.chore_allow_multiple = state_attr(ns.chore_sensor_id, 'allow_multiple_claims_per_day') | string | default('False') -%}

                  {%- set state_map_tf = {
                      'False': ui.get('false', 'err-false'),
                      'True': ui.get('true', 'err-true')
                  } -%}

                  {%- set shared_chore_display = state_map_tf[ns.shared_chore] if ns.shared_chore in state_map_tf else ns.shared_chore -%}
                  {%- set chore_allow_multiple_display = state_map_tf[ns.chore_allow_multiple] if ns.chore_allow_multiple in state_map_tf else ns.chore_allow_multiple -%}
                  {%- set ns.recurrence = state_attr(ns.chore_sensor_id, 'recurring_frequency') if state_attr(ns.chore_sensor_id, 'recurring_frequency') != 'none' else ui.get('none', 'err-none') -%}
                  {%- set ns.chore_value = state_attr(ns.chore_sensor_id, 'default_points') | int(default=0) -%}
                  {%- set ns.chore_icon = state_attr(ns.chore_sensor_id, 'icon') | default('mdi:clipboard-check') -%}
                  {%- set ns.chore_description = state_attr(ns.chore_sensor_id, 'description') | default('') -%}
                  {%- set ns.chore_days = state_attr(ns.chore_sensor_id, 'applicable_days') | default([], true) -%}
                  {%- set ns.chore_custom_freq_unit = state_attr(ns.chore_sensor_id, 'custom_frequency_unit') | default('') -%}
                  {%- set ns.chore_custom_freq_int = state_attr(ns.chore_sensor_id, 'custom_frequency_interval') | default('') -%}

                  {#-- Convert and Format Due Date --#}
                  {%- set due_date_str = state_attr(ns.chore_sensor_id, 'due_date') | string -%}
                  {%- set due_date = as_datetime(due_date_str) if due_date_str and due_date_str not in ['None', 'unknown', 'unavailable'] else None -%}
                  {%- set ns.due_date_formatted = as_timestamp(due_date) | timestamp_custom('%a, %b %d, %Y %I:%M %p', true) if due_date else ui.get('none', 'err-none') -%}

                  {%- set ns.select_new_date_and_time_secondary = ui.get('tap_to_change', 'err-tap_to_change') ~ "\n \n" ~ state_attr('input_datetime.kc_ui_set_date_helper', 'timestamp') | timestamp_custom('%a, %b %d, %Y %I:%M %p', true) if states('input_datetime.kc_ui_set_date_helper') != 'unknown' else ui.get('no_date_set', 'err-no_date_set') -%}

                  {#-- 4. Build Display --#}
                  {%- set ns.content = "### <ha-icon icon='" ~ ns.chore_icon ~ "'></ha-icon> " ~ ui.get('chore_detail', 'err-chore_detail') ~ ": " ~ (ns.chore_selected | title) ~ "  \n" -%}
                  {%- set ns.content = ns.content ~ "#### üìñ &nbsp;&nbsp;" ~ ns.chore_description ~ "  \n" if ns.chore_description else ns.content -%}
                  {%- set ns.content = ns.content ~
                    "**üìå " ~ ui.get('current_status', 'err-current_status') ~ ":** &nbsp;" ~ current_status_display ~ "  \n"
                    "**üåç " ~ ui.get('global_status', 'err-global_status') ~ ":** &nbsp;" ~ global_status_display ~ "  \n"
                    "**üë• " ~ ui.get('shared_chore', 'err-shared_chore') ~ ":** &nbsp;" ~ shared_chore_display ~ "  \n"
                    "**üì• " ~ ui.get('allow_multiple_claims', 'err-allow_multiple_claims') ~ ":** &nbsp;" ~ chore_allow_multiple_display ~ "  \n"
                    "**üíé " ~ ui.get('value', 'err-value') ~ ":** &nbsp;" ~ ns.chore_value ~ " " ~ points_label ~ "  \n\n"
                    "**üìÖ " ~ ui.get('due_date', 'err-due_date') ~ ":** &nbsp;" ~ ns.due_date_formatted ~ "  \n"
                    "**üîÅ " ~ ui.get('recurrence', 'err-recurrence') ~ ":** &nbsp;" ~ ns.recurrence | title ~ "  \n" -%}
                  {%- set ns.content = ns.content ~ (("**üîµ " ~ ui.get('applicable_days', 'err-applicable_days') ~ ":** &nbsp;" ~ ns.chore_days | join(', ') | title)
                    if ns.chore_days is iterable and ns.chore_days | length > 0 else "") -%}
                  {%- set ns.content = ns.content ~ ("**üîµ " ~ ui.get('interval', 'err-interval') ~ ":** &nbsp;" ~ ns.chore_custom_freq_int | int(default=0) ~ " " ~ ns.chore_custom_freq_unit | title
                    if ns.recurrence != ui.get('none', 'err-none') and ns.chore_custom_freq_int else "") -%}
                  {%- set ns.content = ns.content if ns.chore_selected not in ['None', 'unknown', 'unavailable'] else "**üö´ " ~ ui.get('no_chore_selected', 'err-no_chore_selected') ~ "**" -%}
                {%- endif -%}

                {#-- 5. Render --#}
                {{- {
                  'type': 'heading',
                  'icon': 'mdi:rocket-launch',
                  'heading': ui.get('chore_admin_actions', 'err-chore_admin_actions'),
                  'heading_style': 'title'
                } -}},
                {%- if overdue_count > 0 -%}
                {{- {
                  'type': 'grid',
                  'title': '',
                  'columns': 1,
                  'square': false,
                  'cards': [
                    {
                      'type': 'custom:mushroom-template-card',
                      'primary': ui.get('reset_all', 'err-reset_all') ~ ' ' ~ Kid_name ~ '\'s ' ~ ui.get('overdue_chores', 'err-overdue_chores'),
                      'icon': 'mdi:restore-alert',
                      'icon_color': 'orange',
                      'tap_action': {
                        'action': 'call-service',
                        'service': 'kidschores.reset_overdue_chores',
                        'data': {
                          'kid_name': Kid_name
                        }
                      }
                    }
                  ]
                } -}},
                {%- endif -%}
                {{- {
                  'type': 'custom:mushroom-select-card',
                  'entity': chore_select_entity,
                  'name': ui.get('select_chore_edit', 'err-select_chore_edit'),
                  'icon': 'mdi:clipboard-edit',
                  'icon_color': 'blue',
                  'secondary_info': 'none'
                } -}},
                {%- if ns.chore_selected | lower not in ['none', 'unknown', 'unavailable', ''] -%}
                {{- {
                  'type': 'markdown',
                  'content': ns.content
                } -}},
                {%- if states(ns.chore_sensor_id) | lower in ['overdue'] -%}
                {{- {
                  'type': 'grid',
                  'title': '',
                  'columns': 1,
                  'square': false,
                  'cards': [
                    {
                      'type': 'custom:mushroom-template-card',
                      'primary': ui.get('reset_overdue_status', 'err-reset_overdue_status'),
                      'icon': 'mdi:restore',
                      'icon_color': 'orange',
                      'tap_action': {
                        'action': 'call-service',
                        'service': 'kidschores.reset_overdue_chores',
                        'data': {
                          'chore_name': ns.chore_selected,
                          'kid_name': Kid_name
                        }
                      }
                    }
                  ]
                } -}},
                {%- endif -%}
                {{- {
                  'type': 'grid',
                  'title': '',
                  'columns': 4,
                  'square': false,
                  'cards': [
                    {
                      'type': 'custom:mushroom-template-card',
                      'primary': ui.get('plus_next_due', 'err-plus_next_due'),
                      'icon': 'mdi:calendar-refresh',
                      'icon_color': 'blue',
                      'layout': 'vertical',
                      'tap_action': {
                        'action': 'call-service',
                        'service': 'kidschores.skip_chore_due_date',
                        'data': {
                          'chore_name': ns.chore_selected
                        }
                      }
                    },
                    {
                      'type': 'custom:mushroom-template-card',
                      'primary': ui.get('plus_1_day', 'err-plus_1_day'),
                      'icon': 'mdi:calendar-plus',
                      'icon_color': 'blue',
                      'layout': 'vertical',
                      'tap_action': {
                        'action': 'call-service',
                        'service': 'kidschores.set_chore_due_date',
                        'data': {
                          'chore_name': ns.chore_selected,
                          'due_date': (as_datetime(due_date) + timedelta(days=1)).isoformat() if due_date else ''
                        }
                      }
                    },
                    {
                      'type': 'custom:mushroom-template-card',
                      'primary': ui.get('plus_1_week', 'err-plus_1_week'),
                      'icon': 'mdi:calendar-arrow-right',
                      'icon_color': 'blue',
                      'layout': 'vertical',
                      'tap_action': {
                        'action': 'call-service',
                        'service': 'kidschores.set_chore_due_date',
                        'data': {
                          'chore_name': ns.chore_selected,
                          'due_date': (as_datetime(due_date) + timedelta(weeks=1)).isoformat() if due_date else ''
                        }
                      }
                    },
                    {
                      'type': 'custom:mushroom-template-card',
                      'primary': ui.get('clear_date', 'err-clear_date'),
                      'icon': 'mdi:calendar-remove',
                      'icon_color': 'blue',
                      'layout': 'vertical',
                      'tap_action': {
                        'action': 'call-service',
                        'service': 'kidschores.set_chore_due_date',
                        'data': {
                          'chore_name': ns.chore_selected,
                          'due_date': ''
                        }
                      }
                    }
                  ]
                } -}},
                {{- {
                  'type': 'grid',
                  'columns': 1,
                  'square': false,
                  'cards': [
                    {
                      'type': 'custom:mushroom-template-card',
                      'entity': 'input_datetime.kc_ui_set_date_helper',
                      'primary': ui.get('select_new_date', 'err-select_new_date'),
                      'secondary': ns.select_new_date_and_time_secondary,
                      'multiline_secondary': 'true',
                      'fill_container': 'true',
                      'icon': 'mdi:calendar-edit',
                      'icon_color': 'blue',
                      'tap_action': {
                        'action': 'more-info'
                      },
                      'hold_action': {
                        'action': 'call-service',
                        'service': 'kidschores.set_chore_due_date',
                        'data': {
                          'chore_name': ns.chore_selected,
                          'due_date': states('input_datetime.kc_ui_set_date_helper')
                        }
                      }
                    }
                  ]
                } -}},
                {%- endif -%}
                {{- {
                  'type': 'grid',
                  'columns': 1,
                  'square': false,
                  'cards': [
                    {
                      'type': 'custom:mushroom-template-card',
                      'primary': ui.get('configure', 'err-configure'),
                      'fill_container': 'true',
                      'icon': 'mdi:cog',
                      'icon_color': 'blue',
                      'hold_action': {
                        'action': 'more-info'
                      },
                      'tap_action': {
                        'action': 'url',
                        'url_path': '/config/integrations/integration/kidschores'
                      }
                    }
                  ]
                } -}}
      - type: grid
        square: false
        columns: 1
        grid_options:
          columns: full
        cards:
          - type: custom:auto-entities
            card:
              square: false
              type: grid
              columns: 1
            card_param: cards
            filter:
              template: |-
                {#-- ===== PLUSES AND MINUSES - POINTS ===== --#}

                {#-- *** Section 1: User Config (for user editing) *** --#}
                {%- set Kid_name = 'Kidname' -%}

                {#-- *** Section 2: Initialize Variables *** --#}
                {%- set ns = namespace( Kid_name_normalize='' ) -%}
                {%- set ns.Kid_name_normalize = Kid_name | slugify() -%}

                {#-- *** Section 3: Collect Data *** --#}
                {%- set dashboard_helper = 'sensor.kc_' ~ ns.Kid_name_normalize ~ '_ui_dashboard_helper' -%}
                {%- set ui = state_attr(dashboard_helper, 'ui_translations') or {} -%}

                {#-- *** Section 4: Build Display *** --#}
                {#-- No intermediate variables needed for inline translations --#}

                {#-- *** Section 5: Render *** --#}
                {{- {
                  'type': 'heading',
                  'icon': 'mdi:plus-circle-multiple',
                  'heading': ui.get('pluses_and_minuses', 'err-pluses_and_minuses'),
                  'heading_style': 'title',
                } -}},{{- {
                  'type': 'custom:mini-graph-card',
                  'hours_to_show': '168',
                  'unit': ' ',
                  'entities': [
                    {
                    'entity': 'sensor.kc_' ~ ns.Kid_name_normalize ~ '_points'
                    },
                  ]
                } -}},
          - type: custom:auto-entities
            card:
              square: false
              type: grid
              columns: 2
            card_param: cards
            filter:
              template: >-
                {#-- ===== PLUSES AND MINUSES - BONUS ===== --#}

                {#-- *** Section 1: User Config (for user editing) *** --#}
                {%- set Kid_name = 'Kidname' -%}

                {#-- *** Section 2: Initialize Variables *** --#}
                {%- set ns = namespace( Kid_name_normalize='', points_sensor='', points_label='' ) -%}
                {%- set ns.Kid_name_normalize = Kid_name | slugify() -%}
                {%- set ns.points_sensor = 'sensor.kc_' ~ ns.Kid_name_normalize ~ '_points' -%}

                {#-- *** Section 3: Collect Data *** --#}
                {%- set dashboard_helper = 'sensor.kc_' ~ ns.Kid_name_normalize ~ '_ui_dashboard_helper' -%}
                {%- set ui = state_attr(dashboard_helper, 'ui_translations') or {} -%}
                {%- set ns.points_label = state_attr(ns.points_sensor, 'unit_of_measurement') -%}
                {%- set bonus_list = state_attr(dashboard_helper, 'bonuses') | default([], true) -%}

                {#-- *** Section 4: Build Display *** --#}
                {#-- No intermediate variables needed, inline translations directly --#}

                {#-- *** Section 5: Render *** --#}
                {%- for bonus in bonus_list -%}
                  {%- set bonus_sensor_id = bonus.eid if bonus is mapping else bonus -%}
                  {%- set bonus_name = state_attr(bonus_sensor_id, 'bonus_name') | default('Unknown Bonus') -%}
                  {%- set bonus_icon = state_attr(bonus_sensor_id, 'icon') | default('mdi:star') -%}
                  {%- set bonus_points = state_attr(bonus_sensor_id, 'bonus_points') | int(default=0) -%}
                  {%- set bonuses_applied = states(bonus_sensor_id) | int(default=0) -%}
                  {%- set bonus_button_eid = state_attr(bonus_sensor_id, 'bonus_button_eid') | default('') -%}

                  {%- set icon_color =
                    '#00FF00' if bonus_points >= 20 else
                    '#20C997' if bonus_points >= 10 else
                    '#7FFFD4'
                  -%}

                  {{- {
                    'type': 'custom:mushroom-template-card',
                    'entity': bonus_button_eid,
                    'primary': ui.get('bonus', 'err-bonus') ~ ": " ~ bonus_name,
                    'secondary': '‚≠ê ' ~ ui.get('bonus', 'err-bonus') ~ ':  ' ~ (bonus_points | string) ~ ' ' ~ ns.points_label ~ '\n' ~ 'üìä ' ~ ui.get('applied', 'err-applied') ~ ':  ' ~ (bonuses_applied | string) ~ ' ' ~ ui.get('times', 'err-times'),
                    'multiline_secondary': 'true',
                    'layout': 'vertical',
                    'icon': bonus_icon,
                    'icon_color': icon_color,
                    'tap_action': {
                      'action': 'toggle'
                    },
                    'hold_action': {
                      'action': 'more-info'
                    }
                  } -}},
                {%- endfor -%}
          - type: custom:auto-entities
            card:
              square: false
              type: grid
              columns: 6
            card_param: cards
            filter:
              template: >-
                {#-- ===== PLUSES AND MINUSES - POINTS BUTTONS ===== --#}

                {#-- *** Section 1: User Config (for user editing) *** --#}
                {%- set Kid_name = 'Kidname' -%}

                {#-- *** Section 2: Initialize Variables *** --#}
                {%- set ns = namespace( Kid_name_normalize='' ) -%}
                {%- set ns.Kid_name_normalize = Kid_name | slugify() -%}

                {#-- *** Section 3: Collect Data *** --#}
                {%- set dashboard_helper = 'sensor.kc_' ~ ns.Kid_name_normalize ~ '_ui_dashboard_helper' -%}
                {%- set ui = state_attr(dashboard_helper, 'ui_translations') or {} -%}
                {%- set point_buttons = state_attr(dashboard_helper, 'points_buttons') | default([], true) -%}

                {#-- *** Section 4: Build Display *** --#}
                {#-- No intermediate variables needed, render directly --#}

                {#-- *** Section 5: Render *** --#}
                {%- for button_data in point_buttons -%}
                  {%- set button_eid = button_data.eid if button_data is mapping else button_data -%}
                  {%- set button_name = button_data.name if button_data is mapping else '' -%}
                  {%- set primary = button_name | regex_replace('^Points ', '') -%}
                  {%- set is_positive = 'minus' not in button_eid -%}
                  {%- set icon = 'mdi:plus-circle' if is_positive else 'mdi:minus-circle' -%}
                  {%- set icon_color = 'green' if is_positive else 'red' -%}
                  {{- {
                    'type': 'custom:mushroom-template-card',
                    'entity': button_eid,
                    'primary': primary,
                    'icon': icon,
                    'icon_color': icon_color,
                    'layout': 'vertical',
                    'tap_action': {
                      'action': 'toggle'
                    },
                    'hold_action': {
                      'action': 'more-info'
                    }
                  } -}},
                {%- endfor -%}
          - type: custom:auto-entities
            card:
              square: false
              type: grid
              columns: 2
            card_param: cards
            filter:
              template: >-
                {#-- ===== PLUSES AND MINUSES - PENALTY ===== --#}

                {#-- *** Section 1: User Config (for user editing) *** --#}
                {%- set Kid_name = 'Kidname' -%}

                {#-- *** Section 2: Initialize Variables *** --#}
                {%- set ns = namespace(Kid_name_normalize='', points_sensor='', points_label='') -%}
                {%- set ns.Kid_name_normalize = Kid_name | slugify() -%}
                {%- set ns.points_sensor = 'sensor.kc_' ~ ns.Kid_name_normalize ~ '_points' -%}

                {#-- *** Section 3: Collect Data *** --#}
                {%- set dashboard_helper = 'sensor.kc_' ~ ns.Kid_name_normalize ~ '_ui_dashboard_helper' -%}
                {%- set ui = state_attr(dashboard_helper, 'ui_translations') or {} -%}
                {%- set ns.points_label = state_attr(ns.points_sensor, 'unit_of_measurement') -%}
                {%- set penalty_list = state_attr(dashboard_helper, 'penalties') | default([], true) -%}

                {#-- *** Section 4: Build Display *** --#}
                {#-- No intermediate variables needed, inline translations directly --#}

                {#-- *** Section 5: Render *** --#}
                {%- for penalty in penalty_list -%}
                  {%- set penalty_sensor_id = penalty.eid if penalty is mapping else penalty -%}
                  {%- set penalty_name = state_attr(penalty_sensor_id, 'penalty_name') | default('Unknown Penalty') -%}
                  {%- set penalty_icon = state_attr(penalty_sensor_id, 'icon') | default('mdi:alert') -%}
                  {%- set penalty_points = state_attr(penalty_sensor_id, 'penalty_points') | int(default=0) -%}
                  {%- set penalties_applied = states(penalty_sensor_id) | int(default=0) -%}
                  {%- set penalty_button_eid = state_attr(penalty_sensor_id, 'penalty_button_eid') | default('') -%}

                  {%- set icon_color =
                    '#FF4500' if penalty_points >= 20 else
                    '#FFA54F' if penalty_points >= 10 else
                    '#FFD27F'
                  -%}

                  {{- {
                    'type': 'custom:mushroom-template-card',
                    'entity': penalty_button_eid,
                    'primary': ui.get('penalty', 'err-penalty') ~ ": " ~ penalty_name,
                    'secondary': 'üí• ' ~ ui.get('penalty', 'err-penalty') ~ ':  ' ~ (penalty_points | string) ~ ' ' ~ ns.points_label ~ '\n' ~ 'üìä ' ~ ui.get('applied', 'err-applied') ~ ':  ' ~ (penalties_applied | string) ~ ' ' ~ ui.get('times', 'err-times'),
                    'multiline_secondary': 'true',
                    'layout': 'vertical',
                    'icon': penalty_icon,
                    'icon_color': icon_color,
                    'tap_action': {
                      'action': 'toggle'
                    },
                    'hold_action': {
                      'action': 'more-info'
                    }
                  } -}},
                {%- endfor -%}
            sort:
              method: friendly_name
      - square: false
        type: grid
        cards:
          - type: custom:auto-entities
            card:
              square: false
              type: grid
              columns: 1
            card_param: cards
            filter:
              template: |-
                {#-- ===== 7 DAY ACTIVITY LOG ===== --#}

                {#-- *** Section 1: User Config (for user editing) *** --#}
                {%- set Kid_name = 'Kidname' -%}

                {#-- *** Section 2: Initialize Variables *** --#}
                {%- set ns = namespace( Kid_name_normalize='' ) -%}
                {%- set ns.Kid_name_normalize = Kid_name | slugify() -%}

                {#-- *** Section 3: Collect Data *** --#}
                {%- set dashboard_helper = 'sensor.kc_' ~ ns.Kid_name_normalize ~ '_ui_dashboard_helper' -%}
                {%- set ui = state_attr(dashboard_helper, 'ui_translations') or {} -%}
                {%- set entity_list = state_attr(dashboard_helper, 'activity_monitor_entities') | default([], true) -%}

                {#-- *** Section 4: Build Display *** --#}
                {#-- No intermediate variables needed --#}

                {#-- *** Section 5: Render *** --#}
                {{- {
                  'type': 'heading',
                  'icon': 'mdi:clipboard-text',
                  'heading': ui.get('seven_day_activity_log', 'err-seven_day_activity_log'),
                  'heading_style': 'title',
                } -}},{{- {
                  'type': 'logbook',
                  'title': '',
                  'hours_to_show': 168,
                  'target': {
                    'entity_id': entity_list
                  },
                } -}},
        columns: 1
cards: []
